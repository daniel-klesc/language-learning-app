<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Language Learning App - Smart Vocabulary System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
            position: relative;
        }

        /* Settings Icon */
        .settings-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .settings-icon:hover {
            opacity: 1;
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        .settings-menu.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .settings-close {
            margin-left: auto;
            cursor: pointer;
            font-size: 24px;
        }

        .settings-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-item:hover {
            background: #f8f9fa;
        }

        .settings-item-icon {
            font-size: 20px;
        }

        /* Overlay for settings */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .settings-overlay.open {
            display: block;
        }

        /* Study screen specific container for better mobile experience */
        .container.study-mode {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-height: 700px;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-right: 30px; /* Make space for settings icon */
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .time-estimate {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Skill Level Selector */
        .skill-selector {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .skill-selector-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .skill-levels {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .skill-level-btn {
            padding: 10px 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 12px;
        }

        .skill-level-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .skill-level-btn .emoji {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        /* Skill Pills in Session */
        .skill-pills {
            position: absolute;
            top: 8px;
            left: 15px;
            display: flex;
            gap: 4px;
        }

        .skill-pill {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(255,255,255,0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .skill-pill.active {
            background: white;
            color: #28a745;
            transform: scale(1.1);
        }

        /* Long-press menu */
        .skill-switch-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            padding: 8px 0;
            z-index: 3000;
            min-width: 120px;
        }

        .skill-switch-option {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .skill-switch-option:hover {
            background: #f0f0f0;
        }

        .skill-switch-option.current {
            background: #e3f2fd;
            font-weight: bold;
        }

        .daily-goal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goal-title {
            font-size: 16px;
            opacity: 0.9;
        }

        .goal-numbers {
            font-size: 24px;
            font-weight: bold;
        }

        .goal-progress {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .goal-progress-fill {
            background: white;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Session progress card */
        .session-progress-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .session-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        .session-progress-title {
            font-size: 14px;
            opacity: 0.9;
        }

        .session-progress-numbers {
            font-size: 20px;
            font-weight: bold;
            margin-right: 50px;
        }

        .session-progress-bar {
            background: rgba(255,255,255,0.3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .session-progress-fill {
            background: white;
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .session-progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.9;
        }

        /* Beautiful pause button */
        .pause-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.25);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pause-button:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }

        .pause-icon {
            width: 16px;
            height: 16px;
            position: relative;
        }

        .pause-icon::before,
        .pause-icon::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 16px;
            background: white;
            border-radius: 1px;
        }

        .pause-icon::before {
            left: 3px;
        }

        .pause-icon::after {
            right: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
            padding: 15px 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .language-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .language-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .language-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .session-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .session-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .session-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .session-btn .words {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .session-btn .time {
            font-size: 14px;
            color: #666;
        }

        .session-btn .badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-top: 5px;
        }

        /* Multiple Choice Layout */
        .choice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            width: 100%;
        }

        .choice-btn {
            padding: 12px 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .choice-btn:hover:not(:disabled) {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .choice-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .choice-btn.correct {
            border-color: #28a745;
            background: #d4edda;
            animation: correctPulse 0.5s;
        }

        .choice-btn.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            animation: shake 0.5s;
        }

        .choice-btn.dimmed {
            opacity: 0.5;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .choice-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 2px;
        }

        .choice-romanization {
            font-size: 12px;
            color: #666;
        }
        
        /* Development Console Styles */
        .dev-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .dev-console-header {
            color: #ffff00;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        
        .dev-log {
            margin: 2px 0;
            padding: 2px;
        }
        
        .dev-log.error {
            color: #ff6b6b;
        }
        
        .dev-log.success {
            color: #51cf66;
        }
        
        .dev-log.info {
            color: #339af0;
        }
        
        .dev-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 5px 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            z-index: 9998;
        }

        .continue-session {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .continue-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        /* Improved card design for study mode */
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px 20px;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
            min-height: 120px;
            width: 100%;
        }

        .word {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }

        .romanization {
            font-size: 20px;
            color: #666;
            margin-bottom: 15px;
        }

        /* Category badge */
        .category {
            display: inline-block;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Single button design for study mode */
        .study-button {
            width: 100% !important;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #667eea;
            color: white;
            margin-top: auto;
            margin-bottom: 10px;
            display: block !important;
            box-sizing: border-box;
        }

        .study-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .study-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .study-button.next {
            background: #28a745;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .feedback {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            width: 100%;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .feedback.partial {
            background: #fff3cd;
            color: #856404;
        }

        .feedback .correct-spelling {
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .feedback .user-answer {
            font-size: 13px;
            margin-top: 5px;
            font-weight: normal;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
        }

        .no-cards {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .achievement {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .achievement-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 14px;
            opacity: 0.95;
        }

        .history {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .history-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Loading indicator */
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile optimizations for study mode */
        @media (max-width: 480px) {
            .container {
                width: 100%;
                max-width: 100%;
            }

            .container.study-mode {
                padding: 12px;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 1000;
            }

            body {
                padding: 0;
                min-height: 100vh;
                overflow-x: hidden;
            }

            .hidden {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                pointer-events: none !important;
                position: absolute !important;
                left: -9999px !important;
            }
            
            .container:not(.study-mode) {
                border-radius: 0;
                min-height: 100vh;
                padding: 20px 15px;
                box-shadow: none;
            }
            
            .session-progress-card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .word {
                font-size: 28px;
            }
            
            .romanization {
                font-size: 16px;
            }
            
            .card {
                padding: 20px 15px;
                margin-bottom: 12px;
            }

            .choice-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 12px;
            }

            .choice-btn {
                padding: 10px 8px;
                min-height: 55px;
            }

            .choice-text {
                font-size: 14px;
            }

            .choice-romanization {
                font-size: 11px;
            }

            .feedback {
                padding: 10px;
                margin-bottom: 12px;
                font-size: 13px;
            }

            .input-group {
                margin-bottom: 12px;
            }

            input {
                padding: 10px;
                font-size: 15px;
            }

            .study-button {
                padding: 12px;
                font-size: 15px;
                margin-bottom: 5px;
            }

            #study-screen {
                padding-bottom: 10px;
                width: 100%;
                height: 100%;
            }

            .session-progress-numbers {
                font-size: 18px;
                margin-right: 40px;
            }

            .pause-button {
                width: 28px;
                height: 28px;
                top: 10px;
                right: 10px;
            }

            .pause-icon {
                width: 14px;
                height: 14px;
            }

            .pause-icon::before,
            .pause-icon::after {
                width: 3px;
                height: 14px;
            }

            #study-screen {
                display: flex;
                flex-direction: column;
                height: 100%;
                min-height: 0;
            }

            .study-button {
                flex-shrink: 0;
            }
            
            #start-screen, #study-screen, #complete-screen {
                position: relative;
                width: 100%;
            }
            
            #start-screen:not(.hidden) {
                display: block;
            }
            
            #study-screen:not(.hidden) {
                display: flex;
            }
            
            #complete-screen:not(.hidden) {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <!-- Settings Icon -->
        <svg class="settings-icon" onclick="toggleSettings()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m4.22-13.22l-4.24 4.24m0 5.96l4.24 4.24M20 12h-6m-6 0H2m13.22 4.22l-4.24-4.24m0-5.96L6.76 2.76"></path>
        </svg>

        <!-- Home Screen Content -->
        <div id="home-content">
            <div class="header">
                <h1>üéØ Smart Language Learning</h1>
                <div class="time-estimate" id="time-estimate">Daily goal: ~15 minutes</div>
            </div>

            <!-- Skill Level Selector -->
            <div class="skill-selector">
                <div class="skill-selector-title">Default Skill Level</div>
                <div class="skill-levels">
                    <button class="skill-level-btn" data-level="1" onclick="setDefaultSkillLevel(1)">
                        <span class="emoji">üå±</span>
                        Beginner
                    </button>
                    <button class="skill-level-btn" data-level="2" onclick="setDefaultSkillLevel(2)">
                        <span class="emoji">üìò</span>
                        Intermediate
                    </button>
                    <button class="skill-level-btn" data-level="3" onclick="setDefaultSkillLevel(3)">
                        <span class="emoji">üéØ</span>
                        Advanced
                    </button>
                    <button class="skill-level-btn active" data-level="0" onclick="setDefaultSkillLevel(0)">
                        <span class="emoji">ü§ñ</span>
                        Auto
                    </button>
                </div>
            </div>

            <!-- Daily Goal Card -->
            <div class="daily-goal">
                <div class="goal-header">
                    <span class="goal-title">Today's Goal</span>
                    <span class="goal-numbers" id="goal-progress">0/8</span>
                </div>
                <div class="goal-progress">
                    <div class="goal-progress-fill" id="goal-bar" style="width: 0%"></div>
                </div>
                <div class="goal-details">
                    <span id="words-new">New: 0/3</span>
                    <span id="words-review">Review: 0/5</span>
                    <span id="time-spent">Time: 0 min</span>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-learned">0</div>
                    <div class="stat-label">Words Mastered</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>

            <div class="language-selector">
                <button class="language-btn active" data-pair="cs-vi">üá®üáø‚Üíüáªüá≥</button>
                <button class="language-btn" data-pair="vi-zh">üáªüá≥‚Üíüá®üá≥</button>
                <button class="language-btn" data-pair="vi-en">üáªüá≥‚Üíüá¨üáß</button>
            </div>

            <!-- Start Screen with Session Options -->
            <div id="start-screen">
                <div id="continue-session-btn" class="hidden">
                    <button class="continue-session" onclick="continueSession()">
                        üìö Continue Session (<span id="remaining-words">0</span> words left)
                    </button>
                </div>

                <div class="session-options">
                    <div class="session-btn" onclick="startSession(1)">
                        <div class="words">1</div>
                        <div class="time">~1 min</div>
                        <span class="badge">Quick</span>
                    </div>
                    <div class="session-btn recommended" onclick="startSession(3)">
                        <div class="words">3</div>
                        <div class="time">~3 min</div>
                        <span class="badge">Recommended</span>
                    </div>
                    <div class="session-btn" onclick="startSession(5)">
                        <div class="words">5</div>
                        <div class="time">~5 min</div>
                    </div>
                    <div class="session-btn" onclick="startSession(0)">
                        <div class="words">All</div>
                        <div class="time" id="all-time">~8 min</div>
                    </div>
                </div>

                <div class="history">
                    <div class="history-title">Today's Sessions</div>
                    <div id="session-history"></div>
                </div>
            </div>
        </div>

        <!-- Study Screen - Completely separate -->
        <div id="study-screen" class="hidden" style="display: none;">
            <div style="display: flex; flex-direction: column; width: 100%;">
                <!-- Session Progress Card with Skill Pills -->
                <div class="session-progress-card">
                    <div class="skill-pills">
                        <span class="skill-pill" data-level="1" id="pill-beginner">B</span>
                        <span class="skill-pill" data-level="2" id="pill-intermediate">I</span>
                        <span class="skill-pill" data-level="3" id="pill-advanced">A</span>
                    </div>
                    <div class="pause-button" onclick="pauseSession()" title="Pause">
                        <div class="pause-icon"></div>
                    </div>
                    <div class="session-progress-header">
                        <span class="session-progress-title">Session Progress</span>
                        <span class="session-progress-numbers">
                            <span id="current-word-num">1</span>/<span id="total-words">3</span>
                        </span>
                    </div>
                    <div class="session-progress-bar">
                        <div class="session-progress-fill" id="session-bar" style="width: 0%"></div>
                    </div>
                    <div class="session-progress-details">
                        <span id="session-correct">Correct: 0</span>
                        <span id="session-accuracy">Accuracy: 0%</span>
                    </div>
                </div>

                <!-- Card Display -->
                <div class="card">
                    <div class="category" id="category"></div>
                    <div class="word" id="word"></div>
                    <div class="romanization" id="romanization" class="hidden"></div>
                </div>

                <div class="feedback hidden" id="feedback"></div>

                <!-- Multiple Choice Grid (for beginner) -->
                <div class="choice-grid hidden" id="choice-grid">
                    <!-- Choices will be generated dynamically -->
                </div>

                <!-- Text Input (for intermediate/advanced) -->
                <div class="input-group hidden" id="input-group">
                    <input type="text" id="answer" placeholder="Type the translation..." autocomplete="off">
                </div>

                <!-- Action Button -->
                <button class="study-button" id="action-button" onclick="handleButtonClick()">Check Answer</button>
            </div>
        </div>

        <!-- Complete Screen -->
        <div id="complete-screen" class="hidden" style="display: none;">
            <div id="achievement" class="achievement hidden">
                <div class="achievement-title">üéâ Goal Achieved!</div>
                <div class="achievement-desc">You've completed your daily goal!</div>
            </div>
            
            <div class="no-cards">
                <h2>Session Complete!</h2>
                <p style="margin: 20px 0;">
                    Words practiced: <strong id="session-words">0</strong><br>
                    Accuracy: <strong id="session-accuracy-final">0%</strong><br>
                    Time: <strong id="session-time">0</strong> minutes
                </p>
                <button class="btn-primary" onclick="backToStart()">Continue Learning</button>
                <button class="btn-secondary" onclick="finishForToday()" style="margin-top: 10px;">Finish for Now</button>
            </div>
        </div>
    </div>

    <!-- Settings Menu -->
    <div class="settings-menu" id="settings-menu">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: bold;">Settings</span>
            <span class="settings-close" onclick="toggleSettings()">√ó</span>
        </div>
        <div class="settings-item" onclick="openVocabManager()">
            <span class="settings-item-icon">üìö</span>
            <span>Vocabulary Manager</span>
        </div>
        <div class="settings-item" onclick="refreshVocabulary()">
            <span class="settings-item-icon">üîÑ</span>
            <span>Refresh Vocabulary</span>
        </div>
        <div class="settings-item" onclick="showStatistics()">
            <span class="settings-item-icon">üìä</span>
            <span>Statistics</span>
        </div>
        <div class="settings-item" onclick="exportProgress()">
            <span class="settings-item-icon">üíæ</span>
            <span>Export Progress</span>
        </div>
        <div class="settings-item" onclick="resetAllData()">
            <span class="settings-item-icon">üóëÔ∏è</span>
            <span>Reset All Data</span>
        </div>
    </div>
    
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settings-overlay" onclick="toggleSettings()"></div>

    <!-- Skill Switch Menu (appears on long-press) -->
    <div class="skill-switch-menu hidden" id="skill-switch-menu">
        <div class="skill-switch-option" data-level="1" onclick="switchSkillLevel(1)">üå± Beginner</div>
        <div class="skill-switch-option" data-level="2" onclick="switchSkillLevel(2)">üìò Intermediate</div>
        <div class="skill-switch-option" data-level="3" onclick="switchSkillLevel(3)">üéØ Advanced</div>
    </div>

    <!-- Development Console -->
    <button class="dev-toggle hidden" id="dev-toggle" onclick="toggleDevConsole()">Show Dev Console</button>
    <div class="dev-console hidden" id="dev-console">
        <div class="dev-console-header">üîß Development Console</div>
        <div id="dev-logs"></div>
    </div>

    <script>
        // ============= DEVELOPMENT MODE TOGGLE =============
        const DEV_MODE = true;
        
        // Development console logging
        function devLog(message, type = 'info') {
            if (!DEV_MODE) return;
            
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            
            const logDiv = document.getElementById('dev-logs');
            if (logDiv) {
                const logEntry = document.createElement('div');
                logEntry.className = `dev-log ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logDiv.insertBefore(logEntry, logDiv.firstChild);
                
                // Keep only last 50 logs
                while (logDiv.children.length > 50) {
                    logDiv.removeChild(logDiv.lastChild);
                }
            }
        }
        
        function toggleDevConsole() {
            const console = document.getElementById('dev-console');
            const toggle = document.getElementById('dev-toggle');
            if (console.classList.contains('hidden')) {
                console.classList.remove('hidden');
                toggle.textContent = 'Hide Dev Console';
                showVocabularyStatus();
            } else {
                console.classList.add('hidden');
                toggle.textContent = 'Show Dev Console';
            }
        }
        
        function showVocabularyStatus() {
            if (!DEV_MODE) return;
            
            const data = loadProgress();
            const now = Date.now();
            const vocabSet = vocabularyData[currentLanguagePair] || [];
            
            devLog('=== VOCABULARY STATUS ===', 'success');
            devLog(`Current Language Pair: ${currentLanguagePair}`, 'info');
            devLog(`Total vocabulary loaded: ${vocabSet.length} words`, 'info');
            
            let newCount = 0, dueCount = 0, futureCount = 0;
            
            vocabSet.forEach(card => {
                const progress = data.progress?.[currentLanguagePair]?.[card.id];
                if (!progress) {
                    newCount++;
                    devLog(`ID ${card.id}: "${card.word}" - NEW (never seen)`, 'info');
                } else {
                    const daysUntilReview = Math.ceil((progress.nextReview - now) / 86400000);
                    const skillLevel = progress.skillLevel || 1;
                    const skillName = ['', 'Beginner', 'Intermediate', 'Advanced'][skillLevel];
                    
                    if (progress.nextReview <= now) {
                        dueCount++;
                        devLog(`ID ${card.id}: "${card.word}" - DUE NOW (Level ${progress.level}, Skill: ${skillName})`, 'success');
                    } else {
                        futureCount++;
                        devLog(`ID ${card.id}: "${card.word}" - Due in ${daysUntilReview} days (Level ${progress.level}, Skill: ${skillName})`, 'info');
                    }
                }
            });
            
            devLog(`Summary: ${newCount} new, ${dueCount} due, ${futureCount} future`, 'success');
            devLog(`Daily Progress: ${data.dailyProgress?.new || 0}/${dailyGoal.new} new, ${data.dailyProgress?.review || 0}/${dailyGoal.review} review`, 'info');
            devLog(`Default Skill Level: ${defaultSkillLevel === 0 ? 'Auto' : defaultSkillLevel}`, 'info');
        }
        
        // Initialize dev mode
        if (DEV_MODE) {
            window.addEventListener('load', () => {
                document.getElementById('dev-toggle').classList.remove('hidden');
                devLog('Development mode enabled', 'success');
                devLog('Set DEV_MODE = false for production', 'info');
            });
        }

        // ============= CONSTANTS & CONFIGURATION =============
        
        // Skill level constants
        const SKILL_LEVELS = {
            BEGINNER: 1,
            INTERMEDIATE: 2,
            ADVANCED: 3
        };

        const SKILL_NAMES = {
            1: 'Beginner',
            2: 'Intermediate', 
            3: 'Advanced'
        };

        // Spaced repetition configuration
        const BASE_INTERVALS = [1, 3, 7, 14, 30, 90]; // Days

        // Skill level multipliers for progression
        const SKILL_MULTIPLIERS = {
            1: 0.5,    // Beginner: 50% progression
            2: 0.75,   // Intermediate: 75% progression
            3: 1.0     // Advanced: 100% progression
        };

        // Promotion thresholds
        const PROMOTION_THRESHOLD = {
            streak: 3,      // Consecutive correct answers
            accuracy: 0.8   // 80% accuracy at level
        };

        // ============= VOCABULARY DATA =============
        // This will be replaced by external loading, but kept as fallback
        let vocabularyData = {};
        
        // Fallback vocabulary (embedded)
        const fallbackVocabulary = {
            'cs-vi': [
                // Greetings & Politeness
                { id: 1, word: 'ahoj', translation: 'xin ch√†o', romanization: 'sin ch√†o', category: 'greetings', difficulty: 1 },
                { id: 2, word: 'dƒõkuji', translation: 'c·∫£m ∆°n', romanization: 'c·∫£m ∆°n', category: 'greetings', difficulty: 1 },
                { id: 41, word: 'pros√≠m', translation: 'l√†m ∆°n', romanization: 'l√†m ∆°n', category: 'greetings', difficulty: 1 },
                { id: 42, word: 'promi≈àte', translation: 'xin l·ªói', romanization: 'sin l·ªói', category: 'greetings', difficulty: 1 },
                { id: 43, word: 'nashledanou', translation: 't·∫°m bi·ªát', romanization: 't·∫°m bi·ªát', category: 'greetings', difficulty: 1 },
                
                // Basics
                { id: 3, word: 'ano', translation: 'v√¢ng', romanization: 'v√¢ng', category: 'basics', difficulty: 1 },
                { id: 4, word: 'ne', translation: 'kh√¥ng', romanization: 'kh√¥ng', category: 'basics', difficulty: 1 },
                { id: 15, word: 'd≈Øm', translation: 'nh√†', romanization: 'nh√†', category: 'basics', difficulty: 1 },
                { id: 16, word: '≈°kola', translation: 'tr∆∞·ªùng h·ªçc', romanization: 'tr∆∞·ªùng h·ªçc', category: 'basics', difficulty: 2 },
                { id: 17, word: 'kniha', translation: 's√°ch', romanization: 's√°ch', category: 'basics', difficulty: 2 },
                { id: 20, word: 'pr√°ce', translation: 'c√¥ng vi·ªác', romanization: 'c√¥ng vi·ªác', category: 'basics', difficulty: 2 },
                
                // Numbers
                { id: 7, word: 'jeden', translation: 'm·ªôt', romanization: 'm·ªôt', category: 'numbers', difficulty: 1 },
                { id: 8, word: 'dva', translation: 'hai', romanization: 'hai', category: 'numbers', difficulty: 1 },
                { id: 9, word: 't≈ôi', translation: 'ba', romanization: 'ba', category: 'numbers', difficulty: 1 },
                { id: 10, word: 'ƒçty≈ôi', translation: 'b·ªën', romanization: 'b·ªën', category: 'numbers', difficulty: 2 },
                { id: 11, word: 'pƒõt', translation: 'nƒÉm', romanization: 'nƒÉm', category: 'numbers', difficulty: 2 },
                
                // Family
                { id: 12, word: 'rodina', translation: 'gia ƒë√¨nh', romanization: 'gia ƒë√¨nh', category: 'family', difficulty: 2 },
                { id: 13, word: 'matka', translation: 'm·∫π', romanization: 'm·∫π', category: 'family', difficulty: 1 },
                { id: 14, word: 'otec', translation: 'b·ªë', romanization: 'b·ªë', category: 'family', difficulty: 1 },
                
                // Food & Drink
                { id: 5, word: 'voda', translation: 'n∆∞·ªõc', romanization: 'n∆∞·ªõc', category: 'food', difficulty: 1 },
                { id: 6, word: 'chl√©b', translation: 'b√°nh m√¨', romanization: 'b√°nh m√¨', category: 'food', difficulty: 2 }
            ],
            'vi-zh': [
                { id: 21, word: 'xin ch√†o', translation: '‰Ω†Â•Ω', romanization: 'n«ê h«éo', category: 'greetings', difficulty: 1 },
                { id: 22, word: 'c·∫£m ∆°n', translation: 'Ë∞¢Ë∞¢', romanization: 'xi√® xie', category: 'greetings', difficulty: 1 },
                { id: 23, word: 'm·ªôt', translation: '‰∏Ä', romanization: 'yƒ´', category: 'numbers', difficulty: 1 },
                { id: 24, word: 'hai', translation: '‰∫å', romanization: '√®r', category: 'numbers', difficulty: 1 },
                { id: 25, word: 'ba', translation: '‰∏â', romanization: 'sƒÅn', category: 'numbers', difficulty: 1 },
                { id: 26, word: 'n∆∞·ªõc', translation: 'Ê∞¥', romanization: 'shu«ê', category: 'food', difficulty: 1 },
                { id: 27, word: 'c∆°m', translation: 'Á±≥È•≠', romanization: 'm«ê f√†n', category: 'food', difficulty: 2 },
                { id: 28, word: 'gia ƒë√¨nh', translation: 'ÂÆ∂Â∫≠', romanization: 'jiƒÅ t√≠ng', category: 'family', difficulty: 2 },
                { id: 29, word: 'm·∫π', translation: 'Â¶àÂ¶à', romanization: 'mƒÅ ma', category: 'family', difficulty: 1 },
                { id: 30, word: 'b·ªë', translation: 'Áà∏Áà∏', romanization: 'b√† ba', category: 'family', difficulty: 1 }
            ],
            'vi-en': [
                { id: 31, word: 'xin ch√†o', translation: 'hello', romanization: '', category: 'greetings', difficulty: 1 },
                { id: 32, word: 'c·∫£m ∆°n', translation: 'thank you', romanization: '', category: 'greetings', difficulty: 1 },
                { id: 33, word: 'm·ªôt', translation: 'one', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 34, word: 'hai', translation: 'two', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 35, word: 'ba', translation: 'three', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 36, word: 'n∆∞·ªõc', translation: 'water', romanization: '', category: 'food', difficulty: 1 },
                { id: 37, word: 'b√°nh m√¨', translation: 'bread', romanization: '', category: 'food', difficulty: 1 },
                { id: 38, word: 'gia ƒë√¨nh', translation: 'family', romanization: '', category: 'family', difficulty: 1 },
                { id: 39, word: 'nh√†', translation: 'house', romanization: '', category: 'basics', difficulty: 1 },
                { id: 40, word: 'tr∆∞·ªùng h·ªçc', translation: 'school', romanization: '', category: 'basics', difficulty: 2 }
            ]
        };

        // ============= VOCABULARY LOADING SYSTEM =============
        async function loadVocabulary(languagePair, forceRefresh = false) {
            const cacheKey = `vocabularyCache_${languagePair}`;
            const cache = localStorage.getItem(cacheKey);
            const now = Date.now();
            
            // Check cache (24 hour expiry)
            if (!forceRefresh && cache) {
                const cached = JSON.parse(cache);
                if (cached.timestamp && (now - cached.timestamp) < 86400000) {
                    devLog(`Loading vocabulary from cache for ${languagePair}`, 'info');
                    return cached.words;
                }
            }
            
            // Try to load from external files
            try {
                devLog(`Fetching vocabulary files for ${languagePair}...`, 'info');
                const response = await fetch(`./vocabulary/${languagePair}/core.json`);
                
                if (response.ok) {
                    const data = await response.json();
                    const words = data.words || data;
                    
                    // Cache the loaded vocabulary
                    localStorage.setItem(cacheKey, JSON.stringify({
                        timestamp: now,
                        words: words
                    }));
                    
                    devLog(`Loaded ${words.length} words from external file for ${languagePair}`, 'success');
                    return words;
                }
            } catch (error) {
                devLog(`Failed to load external vocabulary for ${languagePair}: ${error.message}`, 'error');
            }
            
            // Fallback to embedded vocabulary
            devLog(`Using fallback vocabulary for ${languagePair}`, 'info');
            return fallbackVocabulary[languagePair] || [];
        }

        async function initializeVocabulary() {
            devLog('Initializing vocabulary system...', 'info');
            
            // Load vocabulary for all language pairs
            for (const pair of ['cs-vi', 'vi-zh', 'vi-en']) {
                vocabularyData[pair] = await loadVocabulary(pair);
            }
            
            devLog('Vocabulary initialization complete', 'success');
        }

        async function refreshVocabulary() {
            devLog('Refreshing all vocabulary...', 'info');
            
            // Show loading indicator
            const settingsMenu = document.getElementById('settings-menu');
            const originalContent = settingsMenu.innerHTML;
            
            // Clear cache and reload
            for (const pair of ['cs-vi', 'vi-zh', 'vi-en']) {
                vocabularyData[pair] = await loadVocabulary(pair, true);
            }
            
            devLog('Vocabulary refresh complete', 'success');
            alert('Vocabulary refreshed successfully!');
            toggleSettings();
        }

        // ============= SETTINGS MENU FUNCTIONS =============
        function toggleSettings() {
            const menu = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                menu.classList.add('open');
                overlay.classList.add('open');
            }
        }

        function openVocabManager() {
            alert('Vocabulary Manager coming soon! This will allow you to:\n\n' +
                  '‚Ä¢ View all loaded vocabulary\n' +
                  '‚Ä¢ Upload custom vocabulary files\n' +
                  '‚Ä¢ Toggle files on/off\n' +
                  '‚Ä¢ Search and filter words');
            toggleSettings();
        }

        function showStatistics() {
            const data = loadProgress();
            let stats = 'Learning Statistics\n\n';
            
            // Count words by skill level
            let skillCounts = { 1: 0, 2: 0, 3: 0 };
            let totalWords = 0;
            
            if (data.progress) {
                Object.values(data.progress).forEach(langPair => {
                    Object.values(langPair).forEach(card => {
                        totalWords++;
                        const level = card.skillLevel || 1;
                        skillCounts[level]++;
                    });
                });
            }
            
            stats += `Total Words Seen: ${totalWords}\n`;
            stats += `Beginner Level: ${skillCounts[1]}\n`;
            stats += `Intermediate Level: ${skillCounts[2]}\n`;
            stats += `Advanced Level: ${skillCounts[3]}\n\n`;
            stats += `Current Streak: ${data.streak || 0} days\n`;
            stats += `Overall Accuracy: ${data.accuracy?.total ? Math.round((data.accuracy.correct / data.accuracy.total) * 100) : 0}%`;
            
            alert(stats);
            toggleSettings();
        }

        function exportProgress() {
            const data = loadProgress();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `language-learning-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toggleSettings();
        }

        function resetAllData() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone!')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ============= LONG-PRESS SKILL SWITCHING =============
        let longPressTimer = null;
        let isLongPress = false;

        function setupSkillPillLongPress() {
            document.querySelectorAll('.skill-pill').forEach(pill => {
                pill.addEventListener('mousedown', startLongPress);
                pill.addEventListener('touchstart', startLongPress);
                pill.addEventListener('mouseup', cancelLongPress);
                pill.addEventListener('touchend', cancelLongPress);
                pill.addEventListener('mouseleave', cancelLongPress);
                pill.addEventListener('touchcancel', cancelLongPress);
            });
        }

        function startLongPress(e) {
            e.preventDefault();
            const pill = e.currentTarget;
            
            // Only allow long-press on the active pill
            if (!pill.classList.contains('active')) return;
            
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                showSkillSwitchMenu(e);
            }, 500);
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function showSkillSwitchMenu(e) {
            const menu = document.getElementById('skill-switch-menu');
            menu.classList.remove('hidden');
            
            // Position the menu
            const rect = e.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            // Mark current level
            document.querySelectorAll('.skill-switch-option').forEach(option => {
                option.classList.remove('current');
                if (parseInt(option.dataset.level) === currentCardSkillLevel) {
                    option.classList.add('current');
                }
            });
            
            // Hide menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', hideSkillSwitchMenu, { once: true });
            }, 100);
        }

        function hideSkillSwitchMenu() {
            document.getElementById('skill-switch-menu').classList.add('hidden');
        }

        function switchSkillLevel(level) {
            currentCardSkillLevel = level;
            devLog(`Switched to ${SKILL_NAMES[level]} level for current card`, 'info');
            
            // Update the UI to reflect the change
            updateCardSkillDisplay(currentSession[currentCardIndex].id);
            
            // Re-show the card with new skill level
            showCard();
            
            hideSkillSwitchMenu();
        }

        // ============= APP STATE =============
        let currentLanguagePair = 'cs-vi';
        let currentSession = [];
        let pausedSession = null;
        let currentCardIndex = 0;
        let sessionStats = {
            correct: 0,
            total: 0,
            startTime: null,
            wordsCompleted: []
        };
        let isAnswerShown = false;
        let dailyGoal = {
            new: 3,
            review: 5,
            completed: { new: 0, review: 0 },
            adaptiveFactor: 1.0
        };
        let defaultSkillLevel = 0; // 0 = Auto, 1-3 = Manual levels
        let currentCardSkillLevel = 1; // Current card's skill level
        let selectedChoiceIndex = -1; // For multiple choice

        // Local Storage Keys
        const STORAGE_KEY = 'languageApp';

        // ============= INITIALIZATION =============
        async function initApp() {
            devLog('Initializing app with vocabulary system...', 'info');
            
            // Initialize vocabulary first
            await initializeVocabulary();
            
            // Ensure proper initial screen state
            document.getElementById('home-content').style.display = 'block';
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('study-screen').style.display = 'none';
            document.getElementById('complete-screen').classList.add('hidden');
            document.getElementById('complete-screen').style.display = 'none';
            document.getElementById('main-container').classList.remove('study-mode');
            
            loadProgress();
            updateDailyGoal();
            updateStats();
            setupEventListeners();
            checkPausedSession();
            updateSessionHistory();
            updateSkillLevelDisplay();
            setupSkillPillLongPress();
            
            devLog('App initialized successfully', 'success');
        }

        // ============= EVENT LISTENERS =============
        function setupEventListeners() {
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.language-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentLanguagePair = this.dataset.pair;
                    updateDailyGoal();
                    checkPausedSession();
                });
            });

            document.getElementById('answer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleButtonClick();
                }
            });
        }

        // ============= SKILL LEVEL FUNCTIONS =============
        function setDefaultSkillLevel(level) {
            defaultSkillLevel = level;
            updateSkillLevelDisplay();
            
            const data = loadProgress();
            data.defaultSkillLevel = level;
            saveProgress(data);
            
            devLog(`Default skill level set to: ${level === 0 ? 'Auto' : SKILL_NAMES[level]}`, 'info');
        }

        function updateSkillLevelDisplay() {
            document.querySelectorAll('.skill-level-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.level) === defaultSkillLevel) {
                    btn.classList.add('active');
                }
            });
        }

        function determineCardSkillLevel(cardId) {
            const data = loadProgress();
            const cardProgress = data.progress?.[currentLanguagePair]?.[cardId];
            
            if (!cardProgress) {
                // New card - use default or beginner
                return defaultSkillLevel === 0 ? SKILL_LEVELS.BEGINNER : defaultSkillLevel;
            }
            
            // Auto mode
            if (defaultSkillLevel === 0) {
                // Use recommended skill level or last used
                return cardProgress.recommendedSkillLevel || cardProgress.skillLevel || SKILL_LEVELS.BEGINNER;
            }
            
            // Manual mode - use selected level
            return defaultSkillLevel;
        }

        function updateCardSkillDisplay(cardId) {
            const data = loadProgress();
            const cardProgress = data.progress?.[currentLanguagePair]?.[cardId];
            
            // Update skill pills
            document.querySelectorAll('.skill-pill').forEach(pill => {
                pill.classList.remove('active');
                if (parseInt(pill.dataset.level) === currentCardSkillLevel) {
                    pill.classList.add('active');
                }
            });
            
            // Check for promotion (only if card has progress)
            if (cardProgress && cardProgress.skillProgress) {
                checkSkillPromotion(cardProgress);
            }
        }
        
        function checkSkillPromotion(cardProgress) {
            const currentStats = cardProgress.skillProgress[currentCardSkillLevel] || { streak: 0, correct: 0, total: 0 };
            
            if (currentCardSkillLevel < 3 && 
                currentStats.streak >= PROMOTION_THRESHOLD.streak && 
                currentStats.total >= 3 &&
                (currentStats.correct / currentStats.total) >= PROMOTION_THRESHOLD.accuracy) {
                
                cardProgress.recommendedSkillLevel = currentCardSkillLevel + 1;
                devLog(`Card ready for promotion to ${SKILL_NAMES[currentCardSkillLevel + 1]}!`, 'success');
            }
        }

        // ============= MULTIPLE CHOICE FUNCTIONS =============
        function generateMultipleChoice(correctCard, allCards) {
            // Filter for good distractors
            const distractors = allCards
                .filter(c => c.id !== correctCard.id)
                .sort((a, b) => {
                    // Prioritize same category
                    if (a.category === correctCard.category && b.category !== correctCard.category) return -1;
                    if (b.category === correctCard.category && a.category !== correctCard.category) return 1;
                    // Then similar difficulty
                    const aDiff = Math.abs(a.difficulty - correctCard.difficulty);
                    const bDiff = Math.abs(b.difficulty - correctCard.difficulty);
                    return aDiff - bDiff;
                })
                .slice(0, 3);
            
            // Shuffle options
            const options = [correctCard, ...distractors].sort(() => Math.random() - 0.5);
            
            return options.map((option, index) => ({
                text: option.translation,
                romanization: option.romanization,
                isCorrect: option.id === correctCard.id,
                index: index
            }));
        }

        function renderMultipleChoice(options) {
            const grid = document.getElementById('choice-grid');
            grid.innerHTML = '';
            grid.classList.remove('hidden');
            
            options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.onclick = () => selectChoice(index);
                btn.innerHTML = `
                    <span class="choice-text">${option.text}</span>
                    ${option.romanization ? `<span class="choice-romanization">${option.romanization}</span>` : ''}
                `;
                btn.dataset.index = index;
                btn.dataset.correct = option.isCorrect;
                grid.appendChild(btn);
            });
        }

        function selectChoice(index) {
            if (isAnswerShown) return;
            
            // Clear previous selection
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Mark new selection
            const btn = document.querySelector(`.choice-btn[data-index="${index}"]`);
            btn.classList.add('selected');
            selectedChoiceIndex = index;
        }

        // ============= ANSWER VALIDATION =============
        function normalizeAnswer(text) {
            return text
                .toLowerCase()
                .normalize('NFD')  // Decompose diacritics
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[^a-z0-9\u4e00-\u9fff]/g, ''); // Keep alphanumeric and Chinese chars
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        function checkIntermediateAnswer(userAnswer, correctAnswer) {
            const normalized = normalizeAnswer(userAnswer);
            const correct = normalizeAnswer(correctAnswer);
            
            // Exact match (normalized)
            if (normalized === correct) return true;
            
            // Allow 1 character difference for typos
            if (levenshteinDistance(normalized, correct) <= 1) return true;
            
            return false;
        }

        // ============= CORE FUNCTIONS =============
        function handleButtonClick() {
            const button = document.getElementById('action-button');
            if (button.classList.contains('next')) {
                nextCard();
            } else {
                checkAnswer();
            }
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                
                // Migrate old data to include skill levels
                if (data.progress) {
                    Object.keys(data.progress).forEach(lang => {
                        Object.keys(data.progress[lang]).forEach(cardId => {
                            const card = data.progress[lang][cardId];
                            if (!card.skillLevel) {
                                card.skillLevel = 1;
                                card.skillProgress = {
                                    1: { correct: 0, total: 0, streak: 0 },
                                    2: { correct: 0, total: 0, streak: 0 },
                                    3: { correct: 0, total: 0, streak: 0 }
                                };
                                card.recommendedSkillLevel = 1;
                            }
                        });
                    });
                }
                
                // Check if it's a new day
                const today = new Date().toDateString();
                if (data.lastStudied !== today) {
                    data.dailyProgress = {
                        new: 0,
                        review: 0,
                        sessions: [],
                        timeSpent: 0,
                        cardsSeen: {}
                    };
                    
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (data.lastStudied === yesterday && data.dailyProgress?.completed) {
                        data.streak = (data.streak || 0) + 1;
                    } else if (data.lastStudied !== yesterday) {
                        data.streak = 0;
                    }
                    
                    data.lastStudied = today;
                    saveProgress(data);
                }
                
                // Load saved default skill level
                if (data.defaultSkillLevel !== undefined) {
                    defaultSkillLevel = data.defaultSkillLevel;
                }
                
                // Load daily goal adjustments
                if (data.adaptiveGoal) {
                    dailyGoal = { ...dailyGoal, ...data.adaptiveGoal };
                }
                
                return data;
            }
            
            // Initialize new user data
            const newData = {
                progress: {},
                streak: 0,
                lastStudied: new Date().toDateString(),
                dailyProgress: {
                    new: 0,
                    review: 0,
                    sessions: [],
                    timeSpent: 0,
                    cardsSeen: {}
                },
                accuracy: { correct: 0, total: 0 },
                totalLearned: 0,
                adaptiveGoal: dailyGoal,
                defaultSkillLevel: 0
            };
            saveProgress(newData);
            return newData;
        }

        function saveProgress(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function updateDailyGoal() {
            const data = loadProgress();
            const dailyProgress = data.dailyProgress || { new: 0, review: 0 };
            
            const totalGoal = dailyGoal.new + dailyGoal.review;
            const totalComplete = dailyProgress.new + dailyProgress.review;
            
            document.getElementById('goal-progress').textContent = `${totalComplete}/${totalGoal}`;
            document.getElementById('goal-bar').style.width = `${(totalComplete / totalGoal) * 100}%`;
            document.getElementById('words-new').textContent = `New: ${dailyProgress.new}/${dailyGoal.new}`;
            document.getElementById('words-review').textContent = `Review: ${dailyProgress.review}/${dailyGoal.review}`;
            document.getElementById('time-spent').textContent = `Time: ${Math.round(dailyProgress.timeSpent || 0)} min`;
            
            const remainingWords = totalGoal - totalComplete;
            const estimatedTime = Math.max(0, remainingWords * 1);
            document.getElementById('time-estimate').textContent = 
                remainingWords > 0 ? `~${estimatedTime} minutes remaining today` : `Daily goal complete! üéâ`;
            
            document.getElementById('all-time').textContent = `~${remainingWords} min`;
        }

        function updateSessionProgress() {
            if (currentSession.length === 0) return;
            
            const progress = ((currentCardIndex) / currentSession.length) * 100;
            document.getElementById('session-bar').style.width = `${progress}%`;
            document.getElementById('session-correct').textContent = `Correct: ${sessionStats.correct}`;
            
            const accuracy = sessionStats.total > 0 
                ? Math.round((sessionStats.correct / sessionStats.total) * 100) 
                : 0;
            document.getElementById('session-accuracy').textContent = `Accuracy: ${accuracy}%`;
        }

        function updateStats() {
            const data = loadProgress();
            document.getElementById('streak').textContent = data.streak || 0;
            
            // Count mastered words (Advanced level with high accuracy)
            let masteredCount = 0;
            if (data.progress) {
                Object.values(data.progress).forEach(langPair => {
                    Object.values(langPair).forEach(card => {
                        const advancedStats = card.skillProgress?.[3];
                        if (advancedStats && advancedStats.total >= 3 && 
                            (advancedStats.correct / advancedStats.total) >= 0.8) {
                            masteredCount++;
                        }
                    });
                });
            }
            document.getElementById('total-learned').textContent = masteredCount;
            
            if (data.accuracy && data.accuracy.total > 0) {
                const acc = Math.round((data.accuracy.correct / data.accuracy.total) * 100);
                document.getElementById('accuracy').textContent = acc + '%';
            }
        }

        function checkPausedSession() {
            const data = loadProgress();
            if (data.pausedSession && data.pausedSession.languagePair === currentLanguagePair) {
                pausedSession = data.pausedSession;
                document.getElementById('continue-session-btn').classList.remove('hidden');
                document.getElementById('remaining-words').textContent = 
                    pausedSession.cards.length - pausedSession.currentIndex;
            } else {
                document.getElementById('continue-session-btn').classList.add('hidden');
                pausedSession = null;
            }
        }

        function startSession(size) {
            devLog(`Starting session with size: ${size}`, 'info');
            
            const data = loadProgress();
            const now = Date.now();
            currentSession = [];
            
            const vocabSet = vocabularyData[currentLanguagePair] || [];
            const newCards = [];
            const reviewCards = [];
            
            vocabSet.forEach(card => {
                const cardProgress = data.progress?.[currentLanguagePair]?.[card.id];
                if (!cardProgress) {
                    newCards.push({...card, type: 'new'});
                } else if (cardProgress.nextReview <= now) {
                    reviewCards.push({...card, type: 'review'});
                }
            });
            
            devLog(`Available: ${newCards.length} new, ${reviewCards.length} review cards`, 'info');
            
            let targetNew = 0;
            let targetReview = 0;
            
            const completedNew = data.dailyProgress?.new || 0;
            const completedReview = data.dailyProgress?.review || 0;
            
            if (size === 0) {
                targetNew = Math.max(0, dailyGoal.new - completedNew);
                targetReview = Math.max(0, dailyGoal.review - completedReview);
            } else {
                let remainingSize = size;
                
                const reviewsNeeded = Math.max(0, dailyGoal.review - completedReview);
                targetReview = Math.min(remainingSize, reviewCards.length, reviewsNeeded);
                remainingSize -= targetReview;
                
                if (remainingSize > 0) {
                    const newNeeded = Math.max(0, dailyGoal.new - completedNew);
                    targetNew = Math.min(remainingSize, newCards.length, newNeeded);
                }
                
                if (targetNew + targetReview < size && completedNew >= dailyGoal.new && completedReview >= dailyGoal.review) {
                    const extraReviews = Math.min(size - targetNew - targetReview, reviewCards.length - targetReview);
                    targetReview += extraReviews;
                }
                
                if (targetNew + targetReview < size) {
                    const extraNew = Math.min(size - targetNew - targetReview, newCards.length - targetNew);
                    targetNew += extraNew;
                }
            }
            
            currentSession = [
                ...reviewCards.slice(0, targetReview),
                ...newCards.slice(0, targetNew)
            ];
            
            if (currentSession.length === 0) {
                const feedback = `
                    <div class="no-cards">
                        <h2>No Cards Available</h2>
                        <p style="margin: 20px 0;">
                            ${reviewCards.length === 0 && newCards.length === 0 ? 
                                'All cards are scheduled for future review. Great job! Come back tomorrow.' :
                                'You\'ve completed your daily goals! Come back tomorrow for more practice.'}
                        </p>
                        <p style="color: #666; font-size: 14px;">
                            Next review: Tomorrow<br>
                            Cards mastered: ${document.getElementById('total-learned').textContent}
                        </p>
                        <button class="btn-primary" onclick="backToStart()">Back to Home</button>
                    </div>
                `;
                document.getElementById('complete-screen').innerHTML = feedback;
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('complete-screen').classList.remove('hidden');
                return;
            }
            
            // Shuffle session
            currentSession.sort(() => Math.random() - 0.5);
            devLog(`Starting session with ${currentSession.length} cards`, 'success');
            
            // Initialize session
            sessionStats = {
                correct: 0,
                total: 0,
                startTime: Date.now(),
                wordsCompleted: []
            };
            currentCardIndex = 0;
            
            // Clear paused session
            pausedSession = null;
            const saveData = loadProgress();
            delete saveData.pausedSession;
            saveProgress(saveData);
            
            // Switch to study mode UI
            document.getElementById('main-container').classList.add('study-mode');
            document.getElementById('home-content').style.display = 'none';
            
            // Show study screen
            document.getElementById('study-screen').classList.remove('hidden');
            document.getElementById('study-screen').style.display = 'flex';
            
            // Re-setup long-press for study screen skill pills
            setupSkillPillLongPress();
            
            showCard();
        }

        function continueSession() {
            if (!pausedSession) return;
            
            currentSession = pausedSession.cards;
            currentCardIndex = pausedSession.currentIndex;
            sessionStats = pausedSession.stats;
            
            // Clear paused session from storage
            const data = loadProgress();
            delete data.pausedSession;
            saveProgress(data);
            pausedSession = null;
            
            // Switch to study mode UI
            document.getElementById('main-container').classList.add('study-mode');
            document.getElementById('home-content').style.display = 'none';
            
            // Show study screen
            document.getElementById('study-screen').classList.remove('hidden');
            document.getElementById('study-screen').style.display = 'flex';
            
            // Re-setup long-press for study screen skill pills
            setupSkillPillLongPress();
            
            showCard();
        }

        function pauseSession() {
            const data = loadProgress();
            
            // Save session state
            data.pausedSession = {
                cards: currentSession,
                currentIndex: currentCardIndex,
                stats: sessionStats,
                languagePair: currentLanguagePair
            };
            
            // Update time spent
            if (sessionStats.startTime) {
                const timeSpent = (Date.now() - sessionStats.startTime) / 60000;
                data.dailyProgress.timeSpent = (data.dailyProgress.timeSpent || 0) + timeSpent;
            }
            
            saveProgress(data);
            
            // Return to home
            backToStart();
        }

        function showCard() {
            if (currentCardIndex >= currentSession.length) {
                completeSession();
                return;
            }
            
            const card = currentSession[currentCardIndex];
            
            // Determine skill level for this card
            currentCardSkillLevel = determineCardSkillLevel(card.id);
            devLog(`Showing card ${card.id} at ${SKILL_NAMES[currentCardSkillLevel]} level`, 'info');
            
            // Update skill display
            updateCardSkillDisplay(card.id);
            
            // Reset UI
            document.getElementById('word').textContent = card.word;
            document.getElementById('category').textContent = card.category;
            document.getElementById('feedback').classList.add('hidden');
            isAnswerShown = false;
            selectedChoiceIndex = -1;
            
            // Hide romanization initially
            const romanizationEl = document.getElementById('romanization');
            if (card.romanization) {
                romanizationEl.textContent = card.romanization;
                romanizationEl.classList.add('hidden');
            } else {
                romanizationEl.classList.add('hidden');
            }
            
            // Show appropriate input method based on skill level
            const choiceGrid = document.getElementById('choice-grid');
            const inputGroup = document.getElementById('input-group');
            
            if (currentCardSkillLevel === SKILL_LEVELS.BEGINNER) {
                // Multiple choice
                choiceGrid.classList.remove('hidden');
                inputGroup.classList.add('hidden');
                
                const vocabSet = vocabularyData[currentLanguagePair] || [];
                const options = generateMultipleChoice(card, vocabSet);
                renderMultipleChoice(options);
            } else {
                // Text input for intermediate and advanced
                choiceGrid.classList.add('hidden');
                inputGroup.classList.remove('hidden');
                document.getElementById('answer').value = '';
                document.getElementById('answer').focus();
                
                // Update placeholder based on level
                const placeholder = currentCardSkillLevel === SKILL_LEVELS.INTERMEDIATE ?
                    'Type the translation (diacritics optional)...' :
                    'Type the exact translation...';
                document.getElementById('answer').placeholder = placeholder;
            }
            
            // Update progress display
            document.getElementById('current-word-num').textContent = currentCardIndex + 1;
            document.getElementById('total-words').textContent = currentSession.length;
            
            // Reset button
            const button = document.getElementById('action-button');
            button.textContent = 'Check Answer';
            button.classList.remove('next');
            
            updateSessionProgress();
        }

        function checkAnswer() {
            if (isAnswerShown) {
                nextCard();
                return;
            }
            
            const card = currentSession[currentCardIndex];
            let isCorrect = false;
            let feedbackMessage = '';
            let feedbackClass = '';
            
            if (currentCardSkillLevel === SKILL_LEVELS.BEGINNER) {
                // Multiple choice
                if (selectedChoiceIndex === -1) {
                    devLog('No choice selected', 'error');
                    return;
                }
                
                const choices = document.querySelectorAll('.choice-btn');
                const selectedBtn = choices[selectedChoiceIndex];
                isCorrect = selectedBtn.dataset.correct === 'true';
                
                // Visual feedback
                choices.forEach(btn => {
                    if (btn.dataset.correct === 'true') {
                        btn.classList.add('correct');
                    } else if (btn === selectedBtn && !isCorrect) {
                        btn.classList.add('incorrect');
                    } else {
                        btn.classList.add('dimmed');
                    }
                    btn.disabled = true;
                });
                
                feedbackMessage = isCorrect ? '‚úì Correct!' : `‚úó Incorrect. The answer is: <strong>${card.translation}</strong>`;
                feedbackClass = isCorrect ? 'correct' : 'incorrect';
                
            } else if (currentCardSkillLevel === SKILL_LEVELS.INTERMEDIATE) {
                // Flexible typing
                const userAnswer = document.getElementById('answer').value.trim();
                const correctAnswer = card.translation;
                
                // Check if it's close enough (without diacritics)
                const isCloseEnough = checkIntermediateAnswer(userAnswer, correctAnswer);
                
                // Check if it's exactly correct
                const isExact = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                
                if (isExact) {
                    feedbackMessage = '‚úì Perfect!';
                    feedbackClass = 'correct';
                    isCorrect = true;
                } else if (isCloseEnough) {
                    feedbackMessage = `‚úì Close enough!`;
                    feedbackMessage += `<div class="user-answer">You typed: ${userAnswer}</div>`;
                    feedbackMessage += `<div class="correct-spelling">Exact spelling: <strong>${correctAnswer}</strong></div>`;
                    feedbackClass = 'partial';
                    isCorrect = true; // Count as correct for progression
                } else {
                    feedbackMessage = `‚úó Incorrect.`;
                    feedbackMessage += `<div class="user-answer">You typed: ${userAnswer}</div>`;
                    feedbackMessage += `<div class="correct-spelling">Correct answer: <strong>${correctAnswer}</strong></div>`;
                    feedbackClass = 'incorrect';
                    isCorrect = false;
                }
                
            } else {
                // Advanced - exact match
                const userAnswer = document.getElementById('answer').value.trim().toLowerCase();
                const correctAnswer = card.translation.toLowerCase();
                
                isCorrect = userAnswer === correctAnswer || 
                          userAnswer === correctAnswer.replace(/\s+/g, '');
                
                feedbackMessage = isCorrect ? '‚úì Perfect!' : `‚úó Incorrect. The answer is: <strong>${card.translation}</strong>`;
                feedbackClass = isCorrect ? 'correct' : 'incorrect';
            }
            
            // Show romanization when answer is checked
            const romanizationEl = document.getElementById('romanization');
            if (card.romanization) {
                romanizationEl.classList.remove('hidden');
            }
            
            // Show feedback
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden');
            feedback.className = `feedback ${feedbackClass}`;
            feedback.innerHTML = feedbackMessage;
            
            // Update progress
            updateCardProgressWithSkillLevel(card.id, isCorrect, currentCardSkillLevel, card.type);
            
            if (isCorrect) {
                sessionStats.correct++;
            }
            sessionStats.total++;
            sessionStats.wordsCompleted.push(card.id);
            
            isAnswerShown = true;
            
            // Change button to "Next Card"
            const button = document.getElementById('action-button');
            button.textContent = currentCardIndex === currentSession.length - 1 ? 'Finish' : 'Next Card';
            button.classList.add('next');
            
            updateSessionProgress();
        }

        function nextCard() {
            currentCardIndex++;
            showCard();
        }

        function updateCardProgressWithSkillLevel(cardId, isCorrect, skillLevel, cardType) {
            const data = loadProgress();
            
            devLog(`Updating card ${cardId}: ${isCorrect ? 'CORRECT' : 'INCORRECT'} at ${SKILL_NAMES[skillLevel]} level (${cardType})`, isCorrect ? 'success' : 'error');
            
            if (!data.progress) data.progress = {};
            if (!data.progress[currentLanguagePair]) data.progress[currentLanguagePair] = {};
            
            let cardProgress = data.progress[currentLanguagePair][cardId];
            const isNewCard = !cardProgress;
            
            if (!cardProgress) {
                // Initialize new card
                cardProgress = {
                    level: 0,
                    lastSeen: Date.now(),
                    timesCorrect: 0,
                    timesSeen: 0,
                    skillLevel: skillLevel,
                    skillProgress: {
                        1: { correct: 0, total: 0, streak: 0 },
                        2: { correct: 0, total: 0, streak: 0 },
                        3: { correct: 0, total: 0, streak: 0 }
                    },
                    recommendedSkillLevel: 1
                };
            }
            
            // Update skill-specific statistics
            if (!cardProgress.skillProgress) {
                cardProgress.skillProgress = {
                    1: { correct: 0, total: 0, streak: 0 },
                    2: { correct: 0, total: 0, streak: 0 },
                    3: { correct: 0, total: 0, streak: 0 }
                };
            }
            
            const skillStats = cardProgress.skillProgress[skillLevel];
            skillStats.total++;
            
            if (isCorrect) {
                skillStats.correct++;
                skillStats.streak++;
                
                // Apply skill multiplier to level progression
                const multiplier = SKILL_MULTIPLIERS[skillLevel];
                cardProgress.level = Math.min(5, cardProgress.level + multiplier);
                cardProgress.timesCorrect++;
                
                devLog(`Card level increased by ${multiplier} to ${cardProgress.level}`, 'info');
            } else {
                skillStats.streak = 0;
                
                // Bigger penalty for failing at easier levels
                const penalty = skillLevel === SKILL_LEVELS.BEGINNER ? 0.5 : 1.0;
                cardProgress.level = Math.max(0, cardProgress.level - penalty);
                
                devLog(`Card level decreased by ${penalty} to ${cardProgress.level}`, 'info');
            }
            
            cardProgress.timesSeen++;
            cardProgress.lastSeen = Date.now();
            cardProgress.skillLevel = skillLevel;
            
            // Calculate next review time based on fractional level
            const effectiveLevel = Math.floor(cardProgress.level);
            const fraction = cardProgress.level - effectiveLevel;
            
            let daysUntilNext;
            if (effectiveLevel >= BASE_INTERVALS.length - 1) {
                daysUntilNext = BASE_INTERVALS[BASE_INTERVALS.length - 1];
            } else {
                const lowerDays = BASE_INTERVALS[effectiveLevel];
                const upperDays = BASE_INTERVALS[effectiveLevel + 1];
                daysUntilNext = lowerDays + (upperDays - lowerDays) * fraction;
            }
            
            cardProgress.nextReview = Date.now() + (daysUntilNext * 86400000);
            
            devLog(`Next review in ${Math.round(daysUntilNext)} days`, 'info');
            
            // Check for skill level promotion
            if (skillStats.streak >= PROMOTION_THRESHOLD.streak && 
                skillStats.total >= 3 &&
                (skillStats.correct / skillStats.total) >= PROMOTION_THRESHOLD.accuracy &&
                skillLevel < 3) {
                cardProgress.recommendedSkillLevel = skillLevel + 1;
                devLog(`Card ${cardId} ready for promotion to ${SKILL_NAMES[skillLevel + 1]}!`, 'success');
            }
            
            data.progress[currentLanguagePair][cardId] = cardProgress;
            
            // Update daily progress
            if (!data.dailyProgress) {
                data.dailyProgress = { new: 0, review: 0, sessions: [], timeSpent: 0, cardsSeen: {} };
            }
            
            // Track if this card was already counted in today's progress
            const cardSeenToday = data.dailyProgress.cardsSeen[cardId];
            
            if (!cardSeenToday) {
                // First time seeing this card today
                data.dailyProgress.cardsSeen[cardId] = true;
                
                if (isNewCard || cardType === 'new') {
                    // This is a new card
                    data.dailyProgress.new = Math.min(dailyGoal.new + 10, (data.dailyProgress.new || 0) + 1);
                    devLog(`Daily new words: ${data.dailyProgress.new}/${dailyGoal.new}`, 'info');
                    
                    // Count as learned if mastered at advanced level
                    if (isCorrect && skillLevel === SKILL_LEVELS.ADVANCED) {
                        data.totalLearned = (data.totalLearned || 0) + 1;
                    }
                } else {
                    // This is a review card
                    data.dailyProgress.review = Math.min(dailyGoal.review + 10, (data.dailyProgress.review || 0) + 1);
                    devLog(`Daily review words: ${data.dailyProgress.review}/${dailyGoal.review}`, 'info');
                }
            }
            
            // Update overall accuracy
            if (!data.accuracy) data.accuracy = { correct: 0, total: 0 };
            data.accuracy.total++;
            if (isCorrect) data.accuracy.correct++;
            
            saveProgress(data);
            updateDailyGoal();
            updateStats();
        }

        function completeSession() {
            const data = loadProgress();
            
            // Calculate session time
            const sessionTime = sessionStats.startTime ? 
                Math.round((Date.now() - sessionStats.startTime) / 60000) : 0;
            
            // Update time spent
            data.dailyProgress.timeSpent = (data.dailyProgress.timeSpent || 0) + sessionTime;
            
            // Add to session history
            if (!data.dailyProgress.sessions) data.dailyProgress.sessions = [];
            data.dailyProgress.sessions.push({
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                words: sessionStats.total,
                accuracy: sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0
            });
            
            // Adaptive goal adjustment
            adjustDailyGoal(data);
            
            saveProgress(data);
            showCompleteScreen();
        }

        function adjustDailyGoal(data) {
            const dailyProgress = data.dailyProgress;
            const sessions = dailyProgress.sessions || [];
            
            // Only adjust after completing at least 2 sessions
            if (sessions.length < 2) return;
            
            // Calculate average accuracy for today
            const todayAccuracy = sessions.reduce((acc, s) => acc + s.accuracy, 0) / sessions.length;
            
            // Adjust goals for tomorrow
            if (todayAccuracy > 85 && dailyProgress.new >= dailyGoal.new && dailyProgress.review >= dailyGoal.review) {
                // Increase slightly if doing well and completing goals
                dailyGoal.new = Math.min(10, dailyGoal.new + 1);
                dailyGoal.review = Math.min(15, dailyGoal.review + 1);
                devLog('Daily goals increased due to excellent performance!', 'success');
            } else if (todayAccuracy < 60) {
                // Decrease if struggling
                dailyGoal.new = Math.max(2, dailyGoal.new - 1);
                dailyGoal.review = Math.max(3, dailyGoal.review - 1);
                devLog('Daily goals decreased to reduce pressure', 'info');
            }
            
            // Save adjusted goals
            data.adaptiveGoal = dailyGoal;
        }

        function showCompleteScreen() {
            const data = loadProgress();
            const totalGoal = dailyGoal.new + dailyGoal.review;
            const totalComplete = (data.dailyProgress?.new || 0) + (data.dailyProgress?.review || 0);
            
            // Hide study screen
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('study-screen').style.display = 'none';
            
            // Hide home content
            document.getElementById('home-content').style.display = 'none';
            
            // Rebuild complete screen HTML to ensure all elements exist
            const completeScreen = document.getElementById('complete-screen');
            completeScreen.innerHTML = `
                <div id="achievement" class="achievement ${totalComplete >= totalGoal ? '' : 'hidden'}">
                    <div class="achievement-title">üéâ Goal Achieved!</div>
                    <div class="achievement-desc">You've completed your daily goal!</div>
                </div>
                
                <div class="no-cards">
                    <h2>Session Complete!</h2>
                    <p style="margin: 20px 0;">
                        Words practiced: <strong>${sessionStats.total}</strong><br>
                        Accuracy: <strong>${sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0}%</strong><br>
                        Time: <strong>${sessionStats.startTime ? Math.round((Date.now() - sessionStats.startTime) / 60000) : 0}</strong> minutes
                    </p>
                    <button class="btn-primary" onclick="backToStart()">Continue Learning</button>
                    <button class="btn-secondary" onclick="finishForToday()" style="margin-top: 10px;">Finish for Now</button>
                </div>
            `;
            
            // Show complete screen
            completeScreen.classList.remove('hidden');
            completeScreen.style.display = 'block';
            
            // Remove study mode
            document.getElementById('main-container').classList.remove('study-mode');
            
            updateStats();
        }

        function updateSessionHistory() {
            const data = loadProgress();
            const sessions = data.dailyProgress?.sessions || [];
            const historyDiv = document.getElementById('session-history');
            
            if (sessions.length === 0) {
                historyDiv.innerHTML = '<div style="color: #999; font-size: 13px;">No sessions yet today</div>';
                return;
            }
            
            historyDiv.innerHTML = sessions.map(s => `
                <div class="history-item">
                    <span>${s.time}</span>
                    <span>${s.words} words ‚Ä¢ ${s.accuracy}%</span>
                </div>
            `).join('');
        }

        function backToStart() {
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('study-screen').style.display = 'none';
            document.getElementById('complete-screen').classList.add('hidden');
            document.getElementById('complete-screen').style.display = 'none';
            
            // Restore normal UI
            document.getElementById('main-container').classList.remove('study-mode');
            document.getElementById('home-content').style.display = 'block';
            
            updateDailyGoal();
            updateStats();
            checkPausedSession();
            updateSessionHistory();
        }

        function finishForToday() {
            backToStart();
        }

        // Initialize when page loads
        window.onload = function() {
            // Force hide study and complete screens on load
            const studyScreen = document.getElementById('study-screen');
            const completeScreen = document.getElementById('complete-screen');
            const homeContent = document.getElementById('home-content');
            
            if (studyScreen) {
                studyScreen.classList.add('hidden');
                studyScreen.style.display = 'none';
            }
            if (completeScreen) {
                completeScreen.classList.add('hidden');
                completeScreen.style.display = 'none';
            }
            if (homeContent) {
                homeContent.style.display = 'block';
            }
            
            // Remove study mode from container
            document.getElementById('main-container').classList.remove('study-mode');
            
            initApp();
        };
    </script>
</body>
</html>