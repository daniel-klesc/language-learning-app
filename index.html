<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Language Learning App - Adaptive Skill Levels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        /* Study screen specific container for better mobile experience */
        .container.study-mode {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-height: 700px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .time-estimate {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Skill Level Selector */
        .skill-selector {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .skill-selector-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .skill-levels {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .skill-level-btn {
            padding: 10px 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 12px;
        }

        .skill-level-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .skill-level-btn .emoji {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        /* Card Skill Indicator */
        .card-skill-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .skill-progress-bars {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .skill-bar {
            flex: 1;
            text-align: center;
        }

        .skill-bar-label {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .skill-bar-track {
            background: rgba(255,255,255,0.3);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .skill-bar-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }

        .skill-promotion {
            background: #28a745;
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .daily-goal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goal-title {
            font-size: 16px;
            opacity: 0.9;
        }

        .goal-numbers {
            font-size: 24px;
            font-weight: bold;
        }

        .goal-progress {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .goal-progress-fill {
            background: white;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Session progress card - similar style to daily goal */
        .session-progress-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .session-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .session-progress-title {
            font-size: 14px;
            opacity: 0.9;
        }

        .session-progress-numbers {
            font-size: 20px;
            font-weight: bold;
            margin-right: 50px; /* Make space for pause button */
        }

        .session-progress-bar {
            background: rgba(255,255,255,0.3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .session-progress-fill {
            background: white;
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .session-progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.9;
        }

        /* Beautiful pause button */
        .pause-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.25);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pause-button:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }

        .pause-icon {
            width: 16px;
            height: 16px;
            position: relative;
        }

        .pause-icon::before,
        .pause-icon::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 16px;
            background: white;
            border-radius: 1px;
        }

        .pause-icon::before {
            left: 3px;
        }

        .pause-icon::after {
            right: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
            padding: 15px 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .language-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .language-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .language-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .session-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .session-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .session-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .session-btn .words {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .session-btn .time {
            font-size: 14px;
            color: #666;
        }

        .session-btn .badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-top: 5px;
        }

        /* Multiple Choice Layout */
        .choice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .choice-btn {
            padding: 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .choice-btn:hover:not(:disabled) {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .choice-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .choice-btn.correct {
            border-color: #28a745;
            background: #d4edda;
            animation: correctPulse 0.5s;
        }

        .choice-btn.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            animation: shake 0.5s;
        }

        .choice-btn.dimmed {
            opacity: 0.5;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .choice-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 4px;
        }

        .choice-romanization {
            font-size: 14px;
            color: #666;
        }
        
        /* Development Console Styles */
        .dev-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .dev-console-header {
            color: #ffff00;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        
        .dev-log {
            margin: 2px 0;
            padding: 2px;
        }
        
        .dev-log.error {
            color: #ff6b6b;
        }
        
        .dev-log.success {
            color: #51cf66;
        }
        
        .dev-log.info {
            color: #339af0;
        }
        
        .dev-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 5px 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            z-index: 9998;
        }

        .continue-session {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .continue-session:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        /* Improved card design for study mode */
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px 20px;
            margin-bottom: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 150px;
        }

        .word {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }

        .romanization {
            font-size: 20px;
            color: #666;
            margin-bottom: 15px;
        }

        /* Category badge */
        .category {
            display: inline-block;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Single button design for study mode */
        .study-button {
            width: 100%;
            padding: 16px;
            font-size: 17px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }

        .study-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .study-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .study-button.next {
            background: #28a745;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .feedback.intermediate {
            background: #fff3cd;
            color: #856404;
        }

        .feedback .correct-spelling {
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .hidden {
            display: none;
        }

        .no-cards {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .achievement {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .achievement-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 14px;
            opacity: 0.95;
        }

        .history {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .history-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Mobile optimizations for study mode */
        @media (max-width: 480px) {
            .container.study-mode {
                padding: 15px;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .word {
                font-size: 32px;
            }
            
            .romanization {
                font-size: 18px;
            }
            
            .card {
                padding: 20px 15px;
            }

            .choice-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="header">
            <h1>ðŸŽ¯ Smart Language Learning</h1>
            <div class="time-estimate" id="time-estimate">Daily goal: ~15 minutes</div>
        </div>

        <!-- Skill Level Selector -->
        <div class="skill-selector">
            <div class="skill-selector-title">Default Skill Level</div>
            <div class="skill-levels">
                <button class="skill-level-btn" data-level="1" onclick="setDefaultSkillLevel(1)">
                    <span class="emoji">ðŸŒ±</span>
                    Beginner
                </button>
                <button class="skill-level-btn" data-level="2" onclick="setDefaultSkillLevel(2)">
                    <span class="emoji">ðŸ“˜</span>
                    Intermediate
                </button>
                <button class="skill-level-btn" data-level="3" onclick="setDefaultSkillLevel(3)">
                    <span class="emoji">ðŸŽ¯</span>
                    Advanced
                </button>
                <button class="skill-level-btn active" data-level="0" onclick="setDefaultSkillLevel(0)">
                    <span class="emoji">ðŸ¤–</span>
                    Auto
                </button>
            </div>
        </div>

        <!-- Daily Goal Card -->
        <div class="daily-goal">
            <div class="goal-header">
                <span class="goal-title">Today's Goal</span>
                <span class="goal-numbers" id="goal-progress">0/8</span>
            </div>
            <div class="goal-progress">
                <div class="goal-progress-fill" id="goal-bar" style="width: 0%"></div>
            </div>
            <div class="goal-details">
                <span id="words-new">New: 0/3</span>
                <span id="words-review">Review: 0/5</span>
                <span id="time-spent">Time: 0 min</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-learned">0</div>
                <div class="stat-label">Words Mastered</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <div class="language-selector">
            <button class="language-btn active" data-pair="cs-vi">ðŸ‡¨ðŸ‡¿â†’ðŸ‡»ðŸ‡³</button>
            <button class="language-btn" data-pair="vi-zh">ðŸ‡»ðŸ‡³â†’ðŸ‡¨ðŸ‡³</button>
            <button class="language-btn" data-pair="vi-en">ðŸ‡»ðŸ‡³â†’ðŸ‡¬ðŸ‡§</button>
        </div>

        <!-- Start Screen with Session Options -->
        <div id="start-screen">
            <div id="continue-session-btn" class="hidden">
                <button class="continue-session" onclick="continueSession()">
                    ðŸ“š Continue Session (<span id="remaining-words">0</span> words left)
                </button>
            </div>

            <div class="session-options">
                <div class="session-btn" onclick="startSession(1)">
                    <div class="words">1</div>
                    <div class="time">~1 min</div>
                    <span class="badge">Quick</span>
                </div>
                <div class="session-btn recommended" onclick="startSession(3)">
                    <div class="words">3</div>
                    <div class="time">~3 min</div>
                    <span class="badge">Recommended</span>
                </div>
                <div class="session-btn" onclick="startSession(5)">
                    <div class="words">5</div>
                    <div class="time">~5 min</div>
                </div>
                <div class="session-btn" onclick="startSession(0)">
                    <div class="words">All</div>
                    <div class="time" id="all-time">~8 min</div>
                </div>
            </div>

            <div class="history">
                <div class="history-title">Today's Sessions</div>
                <div id="session-history"></div>
            </div>
        </div>

        <!-- Study Screen -->
        <div id="study-screen" class="hidden">
            <!-- Session Progress Card -->
            <div class="session-progress-card">
                <div class="pause-button" onclick="pauseSession()" title="Pause">
                    <div class="pause-icon"></div>
                </div>
                <div class="session-progress-header">
                    <span class="session-progress-title">Session Progress</span>
                    <span class="session-progress-numbers">
                        <span id="current-word-num">1</span>/<span id="total-words">3</span>
                    </span>
                </div>
                <div class="session-progress-bar">
                    <div class="session-progress-fill" id="session-bar" style="width: 0%"></div>
                </div>
                <div class="session-progress-details">
                    <span id="session-correct">Correct: 0</span>
                    <span id="session-accuracy">Accuracy: 0%</span>
                </div>
            </div>

            <!-- Card Skill Display -->
            <div class="card-skill-display hidden" id="card-skill-display">
                <div>Current Level: <strong id="current-skill-level">Beginner</strong></div>
                <div class="skill-progress-bars">
                    <div class="skill-bar">
                        <div class="skill-bar-label">Beginner</div>
                        <div class="skill-bar-track">
                            <div class="skill-bar-fill" id="beginner-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-bar-label">Intermediate</div>
                        <div class="skill-bar-track">
                            <div class="skill-bar-fill" id="intermediate-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-bar-label">Advanced</div>
                        <div class="skill-bar-track">
                            <div class="skill-bar-fill" id="advanced-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="skill-promotion hidden" id="skill-promotion" onclick="acceptSkillPromotion()">
                    ðŸŽ‰ Ready for next level! Click to try â†’
                </div>
            </div>

            <!-- Card Display -->
            <div class="card">
                <div class="category" id="category"></div>
                <div class="word" id="word"></div>
                <div class="romanization" id="romanization" class="hidden"></div>
            </div>

            <div class="feedback hidden" id="feedback"></div>

            <!-- Multiple Choice Grid (for beginner) -->
            <div class="choice-grid hidden" id="choice-grid">
                <!-- Choices will be generated dynamically -->
            </div>

            <!-- Text Input (for intermediate/advanced) -->
            <div class="input-group hidden" id="input-group">
                <input type="text" id="answer" placeholder="Type the translation..." autocomplete="off">
            </div>

            <!-- Action Button -->
            <button class="study-button" id="action-button" onclick="handleButtonClick()">Check Answer</button>
        </div>

        <!-- Complete Screen -->
        <div id="complete-screen" class="hidden">
            <div id="achievement" class="achievement hidden">
                <div class="achievement-title">ðŸŽ‰ Goal Achieved!</div>
                <div class="achievement-desc">You've completed your daily goal!</div>
            </div>
            
            <div class="no-cards">
                <h2>Session Complete!</h2>
                <p style="margin: 20px 0;">
                    Words practiced: <strong id="session-words">0</strong><br>
                    Accuracy: <strong id="session-accuracy-final">0%</strong><br>
                    Time: <strong id="session-time">0</strong> minutes
                </p>
                <button class="btn-primary" onclick="backToStart()">Continue Learning</button>
                <button class="btn-secondary" onclick="finishForToday()" style="margin-top: 10px;">Finish for Now</button>
            </div>
        </div>
    </div>

    <!-- Development Console -->
    <button class="dev-toggle hidden" id="dev-toggle" onclick="toggleDevConsole()">Show Dev Console</button>
    <div class="dev-console hidden" id="dev-console">
        <div class="dev-console-header">ðŸ”§ Development Console</div>
        <div id="dev-logs"></div>
    </div>

    <script>
        // ============= DEVELOPMENT MODE TOGGLE =============
        const DEV_MODE = true;
        
        // Development console logging
        function devLog(message, type = 'info') {
            if (!DEV_MODE) return;
            
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            
            const logDiv = document.getElementById('dev-logs');
            if (logDiv) {
                const logEntry = document.createElement('div');
                logEntry.className = `dev-log ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logDiv.insertBefore(logEntry, logDiv.firstChild);
                
                // Keep only last 50 logs
                while (logDiv.children.length > 50) {
                    logDiv.removeChild(logDiv.lastChild);
                }
            }
        }
        
        function toggleDevConsole() {
            const console = document.getElementById('dev-console');
            const toggle = document.getElementById('dev-toggle');
            if (console.classList.contains('hidden')) {
                console.classList.remove('hidden');
                toggle.textContent = 'Hide Dev Console';
                showVocabularyStatus();
            } else {
                console.classList.add('hidden');
                toggle.textContent = 'Show Dev Console';
            }
        }
        
        function showVocabularyStatus() {
            if (!DEV_MODE) return;
            
            const data = loadProgress();
            const now = Date.now();
            const vocabSet = vocabulary[currentLanguagePair] || [];
            
            devLog('=== VOCABULARY STATUS ===', 'success');
            devLog(`Current Language Pair: ${currentLanguagePair}`, 'info');
            
            let newCount = 0, dueCount = 0, futureCount = 0;
            
            vocabSet.forEach(card => {
                const progress = data.progress?.[currentLanguagePair]?.[card.id];
                if (!progress) {
                    newCount++;
                    devLog(`ID ${card.id}: "${card.word}" - NEW (never seen)`, 'info');
                } else {
                    const daysUntilReview = Math.ceil((progress.nextReview - now) / 86400000);
                    const skillLevel = progress.skillLevel || 1;
                    const skillName = ['', 'Beginner', 'Intermediate', 'Advanced'][skillLevel];
                    
                    if (progress.nextReview <= now) {
                        dueCount++;
                        devLog(`ID ${card.id}: "${card.word}" - DUE NOW (Level ${progress.level}, Skill: ${skillName})`, 'success');
                    } else {
                        futureCount++;
                        devLog(`ID ${card.id}: "${card.word}" - Due in ${daysUntilReview} days (Level ${progress.level}, Skill: ${skillName})`, 'info');
                    }
                }
            });
            
            devLog(`Summary: ${newCount} new, ${dueCount} due, ${futureCount} future`, 'success');
            devLog(`Daily Progress: ${data.dailyProgress?.new || 0}/${dailyGoal.new} new, ${data.dailyProgress?.review || 0}/${dailyGoal.review} review`, 'info');
            devLog(`Default Skill Level: ${defaultSkillLevel === 0 ? 'Auto' : defaultSkillLevel}`, 'info');
        }
        
        // Initialize dev mode
        if (DEV_MODE) {
            window.addEventListener('load', () => {
                document.getElementById('dev-toggle').classList.remove('hidden');
                devLog('Development mode enabled', 'success');
                devLog('Set DEV_MODE = false for production', 'info');
            });
        }

        // ============= CONSTANTS & CONFIGURATION =============
        
        // Skill level constants
        const SKILL_LEVELS = {
            BEGINNER: 1,
            INTERMEDIATE: 2,
            ADVANCED: 3
        };

        const SKILL_NAMES = {
            1: 'Beginner',
            2: 'Intermediate', 
            3: 'Advanced'
        };

        // Spaced repetition configuration
        const BASE_INTERVALS = [1, 3, 7, 14, 30, 90]; // Days

        // Skill level multipliers for progression
        const SKILL_MULTIPLIERS = {
            1: 0.5,    // Beginner: 50% progression
            2: 0.75,   // Intermediate: 75% progression
            3: 1.0     // Advanced: 100% progression
        };

        // Promotion thresholds
        const PROMOTION_THRESHOLD = {
            streak: 3,      // Consecutive correct answers
            accuracy: 0.8   // 80% accuracy at level
        };

        // ============= VOCABULARY DATABASE =============
        const vocabulary = {
            'cs-vi': [
                { id: 1, word: 'ahoj', translation: 'xin chÃ o', romanization: 'sin chÃ o', category: 'greetings', difficulty: 1 },
                { id: 2, word: 'dÄ›kuji', translation: 'cáº£m Æ¡n', romanization: 'cáº£m Æ¡n', category: 'greetings', difficulty: 1 },
                { id: 3, word: 'ano', translation: 'vÃ¢ng', romanization: 'vÃ¢ng', category: 'basics', difficulty: 1 },
                { id: 4, word: 'ne', translation: 'khÃ´ng', romanization: 'khÃ´ng', category: 'basics', difficulty: 1 },
                { id: 5, word: 'voda', translation: 'nÆ°á»›c', romanization: 'nÆ°á»›c', category: 'food', difficulty: 1 },
                { id: 6, word: 'chlÃ©b', translation: 'bÃ¡nh mÃ¬', romanization: 'bÃ¡nh mÃ¬', category: 'food', difficulty: 2 },
                { id: 7, word: 'jeden', translation: 'má»™t', romanization: 'má»™t', category: 'numbers', difficulty: 1 },
                { id: 8, word: 'dva', translation: 'hai', romanization: 'hai', category: 'numbers', difficulty: 1 },
                { id: 9, word: 'tÅ™i', translation: 'ba', romanization: 'ba', category: 'numbers', difficulty: 1 },
                { id: 10, word: 'ÄtyÅ™i', translation: 'bá»‘n', romanization: 'bá»‘n', category: 'numbers', difficulty: 2 },
                { id: 11, word: 'pÄ›t', translation: 'nÄƒm', romanization: 'nÄƒm', category: 'numbers', difficulty: 2 },
                { id: 12, word: 'rodina', translation: 'gia Ä‘Ã¬nh', romanization: 'gia Ä‘Ã¬nh', category: 'family', difficulty: 2 },
                { id: 13, word: 'matka', translation: 'máº¹', romanization: 'máº¹', category: 'family', difficulty: 1 },
                { id: 14, word: 'otec', translation: 'bá»‘', romanization: 'bá»‘', category: 'family', difficulty: 1 },
                { id: 15, word: 'dÅ¯m', translation: 'nhÃ ', romanization: 'nhÃ ', category: 'basics', difficulty: 1 },
                { id: 16, word: 'Å¡kola', translation: 'trÆ°á»ng há»c', romanization: 'trÆ°á»ng há»c', category: 'basics', difficulty: 2 },
                { id: 17, word: 'kniha', translation: 'sÃ¡ch', romanization: 'sÃ¡ch', category: 'basics', difficulty: 2 },
                { id: 18, word: 'pÅ™Ã¡telÃ©', translation: 'báº¡n bÃ¨', romanization: 'báº¡n bÃ¨', category: 'people', difficulty: 2 },
                { id: 19, word: 'lÃ¡ska', translation: 'tÃ¬nh yÃªu', romanization: 'tÃ¬nh yÃªu', category: 'emotions', difficulty: 3 },
                { id: 20, word: 'prÃ¡ce', translation: 'cÃ´ng viá»‡c', romanization: 'cÃ´ng viá»‡c', category: 'basics', difficulty: 2 }
            ],
            'vi-zh': [
                { id: 21, word: 'xin chÃ o', translation: 'ä½ å¥½', romanization: 'nÇ hÇŽo', category: 'greetings', difficulty: 1 },
                { id: 22, word: 'cáº£m Æ¡n', translation: 'è°¢è°¢', romanization: 'xiÃ¨ xie', category: 'greetings', difficulty: 1 },
                { id: 23, word: 'má»™t', translation: 'ä¸€', romanization: 'yÄ«', category: 'numbers', difficulty: 1 },
                { id: 24, word: 'hai', translation: 'äºŒ', romanization: 'Ã¨r', category: 'numbers', difficulty: 1 },
                { id: 25, word: 'ba', translation: 'ä¸‰', romanization: 'sÄn', category: 'numbers', difficulty: 1 },
                { id: 26, word: 'nÆ°á»›c', translation: 'æ°´', romanization: 'shuÇ', category: 'food', difficulty: 1 },
                { id: 27, word: 'cÆ¡m', translation: 'ç±³é¥­', romanization: 'mÇ fÃ n', category: 'food', difficulty: 2 },
                { id: 28, word: 'gia Ä‘Ã¬nh', translation: 'å®¶åº­', romanization: 'jiÄ tÃ­ng', category: 'family', difficulty: 2 },
                { id: 29, word: 'máº¹', translation: 'å¦ˆå¦ˆ', romanization: 'mÄ ma', category: 'family', difficulty: 1 },
                { id: 30, word: 'bá»‘', translation: 'çˆ¸çˆ¸', romanization: 'bÃ  ba', category: 'family', difficulty: 1 }
            ],
            'vi-en': [
                { id: 31, word: 'xin chÃ o', translation: 'hello', romanization: '', category: 'greetings', difficulty: 1 },
                { id: 32, word: 'cáº£m Æ¡n', translation: 'thank you', romanization: '', category: 'greetings', difficulty: 1 },
                { id: 33, word: 'má»™t', translation: 'one', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 34, word: 'hai', translation: 'two', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 35, word: 'ba', translation: 'three', romanization: '', category: 'numbers', difficulty: 1 },
                { id: 36, word: 'nÆ°á»›c', translation: 'water', romanization: '', category: 'food', difficulty: 1 },
                { id: 37, word: 'bÃ¡nh mÃ¬', translation: 'bread', romanization: '', category: 'food', difficulty: 1 },
                { id: 38, word: 'gia Ä‘Ã¬nh', translation: 'family', romanization: '', category: 'family', difficulty: 1 },
                { id: 39, word: 'nhÃ ', translation: 'house', romanization: '', category: 'basics', difficulty: 1 },
                { id: 40, word: 'trÆ°á»ng há»c', translation: 'school', romanization: '', category: 'basics', difficulty: 2 }
            ]
        };

        // ============= APP STATE =============
        let currentLanguagePair = 'cs-vi';
        let currentSession = [];
        let pausedSession = null;
        let currentCardIndex = 0;
        let sessionStats = {
            correct: 0,
            total: 0,
            startTime: null,
            wordsCompleted: []
        };
        let isAnswerShown = false;
        let dailyGoal = {
            new: 3,
            review: 5,
            completed: { new: 0, review: 0 },
            adaptiveFactor: 1.0
        };
        let defaultSkillLevel = 0; // 0 = Auto, 1-3 = Manual levels
        let currentCardSkillLevel = 1; // Current card's skill level
        let selectedChoiceIndex = -1; // For multiple choice

        // Local Storage Keys
        const STORAGE_KEY = 'languageApp';

        // ============= INITIALIZATION =============
        function initApp() {
            devLog('Initializing app with skill levels...', 'info');
            loadProgress();
            updateDailyGoal();
            updateStats();
            setupEventListeners();
            checkPausedSession();
            updateSessionHistory();
            updateSkillLevelDisplay();
            devLog('App initialized successfully', 'success');
        }

        // ============= EVENT LISTENERS =============
        function setupEventListeners() {
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.language-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentLanguagePair = this.dataset.pair;
                    updateDailyGoal();
                    checkPausedSession();
                });
            });

            document.getElementById('answer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleButtonClick();
                }
            });
        }

        // ============= SKILL LEVEL FUNCTIONS =============
        function setDefaultSkillLevel(level) {
            defaultSkillLevel = level;
            updateSkillLevelDisplay();
            
            const data = loadProgress();
            data.defaultSkillLevel = level;
            saveProgress(data);
            
            devLog(`Default skill level set to: ${level === 0 ? 'Auto' : SKILL_NAMES[level]}`, 'info');
        }

        function updateSkillLevelDisplay() {
            document.querySelectorAll('.skill-level-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.level) === defaultSkillLevel) {
                    btn.classList.add('active');
                }
            });
        }

        function determineCardSkillLevel(cardId) {
            const data = loadProgress();
            const cardProgress = data.progress?.[currentLanguagePair]?.[cardId];
            
            if (!cardProgress) {
                // New card - use default or beginner
                return defaultSkillLevel === 0 ? SKILL_LEVELS.BEGINNER : defaultSkillLevel;
            }
            
            // Auto mode
            if (defaultSkillLevel === 0) {
                // Use recommended skill level or last used
                return cardProgress.recommendedSkillLevel || cardProgress.skillLevel || SKILL_LEVELS.BEGINNER;
            }
            
            // Manual mode - use selected level
            return defaultSkillLevel;
        }

        function updateCardSkillDisplay(cardId) {
            const data = loadProgress();
            const cardProgress = data.progress?.[currentLanguagePair]?.[cardId];
            
            if (!cardProgress || !cardProgress.skillProgress) {
                document.getElementById('card-skill-display').classList.add('hidden');
                return;
            }
            
            document.getElementById('card-skill-display').classList.remove('hidden');
            document.getElementById('current-skill-level').textContent = SKILL_NAMES[currentCardSkillLevel];
            
            // Update progress bars
            for (let level = 1; level <= 3; level++) {
                const stats = cardProgress.skillProgress[level] || { correct: 0, total: 0 };
                const accuracy = stats.total > 0 ? (stats.correct / stats.total) * 100 : 0;
                const barId = ['', 'beginner', 'intermediate', 'advanced'][level] + '-progress';
                document.getElementById(barId).style.width = `${accuracy}%`;
            }
            
            // Check for promotion
            checkSkillPromotion(cardProgress);
        }

        function checkSkillPromotion(cardProgress) {
            const currentStats = cardProgress.skillProgress[currentCardSkillLevel] || { streak: 0, correct: 0, total: 0 };
            const promotionDiv = document.getElementById('skill-promotion');
            
            if (currentCardSkillLevel < 3 && 
                currentStats.streak >= PROMOTION_THRESHOLD.streak && 
                currentStats.total >= 3 &&
                (currentStats.correct / currentStats.total) >= PROMOTION_THRESHOLD.accuracy) {
                
                promotionDiv.classList.remove('hidden');
                cardProgress.recommendedSkillLevel = currentCardSkillLevel + 1;
            } else {
                promotionDiv.classList.add('hidden');
            }
        }

        function acceptSkillPromotion() {
            const card = currentSession[currentCardIndex];
            const data = loadProgress();
            const cardProgress = data.progress[currentLanguagePair][card.id];
            
            if (cardProgress && cardProgress.recommendedSkillLevel) {
                currentCardSkillLevel = cardProgress.recommendedSkillLevel;
                cardProgress.skillLevel = currentCardSkillLevel;
                saveProgress(data);
                
                devLog(`Card ${card.id} promoted to ${SKILL_NAMES[currentCardSkillLevel]}!`, 'success');
                document.getElementById('skill-promotion').classList.add('hidden');
                
                // Refresh the card display with new skill level
                showCard();
            }
        }

        // ============= MULTIPLE CHOICE FUNCTIONS =============
        function generateMultipleChoice(correctCard, allCards) {
            // Filter for good distractors
            const distractors = allCards
                .filter(c => c.id !== correctCard.id)
                .sort((a, b) => {
                    // Prioritize same category
                    if (a.category === correctCard.category && b.category !== correctCard.category) return -1;
                    if (b.category === correctCard.category && a.category !== correctCard.category) return 1;
                    // Then similar difficulty
                    const aDiff = Math.abs(a.difficulty - correctCard.difficulty);
                    const bDiff = Math.abs(b.difficulty - correctCard.difficulty);
                    return aDiff - bDiff;
                })
                .slice(0, 3);
            
            // Shuffle options
            const options = [correctCard, ...distractors].sort(() => Math.random() - 0.5);
            
            return options.map((option, index) => ({
                text: option.translation,
                romanization: option.romanization,
                isCorrect: option.id === correctCard.id,
                index: index
            }));
        }

        function renderMultipleChoice(options) {
            const grid = document.getElementById('choice-grid');
            grid.innerHTML = '';
            grid.classList.remove('hidden');
            
            options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.onclick = () => selectChoice(index);
                btn.innerHTML = `
                    <span class="choice-text">${option.text}</span>
                    ${option.romanization ? `<span class="choice-romanization">${option.romanization}</span>` : ''}
                `;
                btn.dataset.index = index;
                btn.dataset.correct = option.isCorrect;
                grid.appendChild(btn);
            });
        }

        function selectChoice(index) {
            if (isAnswerShown) return;
            
            // Clear previous selection
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Mark new selection
            const btn = document.querySelector(`.choice-btn[data-index="${index}"]`);
            btn.classList.add('selected');
            selectedChoiceIndex = index;
        }

        // ============= ANSWER VALIDATION =============
        function normalizeAnswer(text) {
            return text
                .toLowerCase()
                .normalize('NFD')  // Decompose diacritics
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[^a-z0-9\u4e00-\u9fff]/g, ''); // Keep alphanumeric and Chinese chars
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        function checkIntermediateAnswer(userAnswer, correctAnswer) {
            const normalized = normalizeAnswer(userAnswer);
            const correct = normalizeAnswer(correctAnswer);
            
            // Exact match (normalized)
            if (normalized === correct) return true;
            
            // Allow 1 character difference for typos
            if (levenshteinDistance(normalized, correct) <= 1) return true;
            
            return false;
        }

        // ============= CORE FUNCTIONS =============
        function handleButtonClick() {
            const button = document.getElementById('action-button');
            if (button.classList.contains('next')) {
                nextCard();
            } else {
                checkAnswer();
            }
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                
                // Migrate old data to include skill levels
                if (data.progress) {
                    Object.keys(data.progress).forEach(lang => {
                        Object.keys(data.progress[lang]).forEach(cardId => {
                            const card = data.progress[lang][cardId];
                            if (!card.skillLevel) {
                                card.skillLevel = 1;
                                card.skillProgress = {
                                    1: { correct: 0, total: 0, streak: 0 },
                                    2: { correct: 0, total: 0, streak: 0 },
                                    3: { correct: 0, total: 0, streak: 0 }
                                };
                                card.recommendedSkillLevel = 1;
                            }
                        });
                    });
                }
                
                // Check if it's a new day
                const today = new Date().toDateString();
                if (data.lastStudied !== today) {
                    data.dailyProgress = {
                        new: 0,
                        review: 0,
                        sessions: [],
                        timeSpent: 0
                    };
                    
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (data.lastStudied === yesterday && data.dailyProgress?.completed) {
                        data.streak = (data.streak || 0) + 1;
                    } else if (data.lastStudied !== yesterday) {
                        data.streak = 0;
                    }
                    
                    data.lastStudied = today;
                    saveProgress(data);
                }
                
                // Load saved default skill level
                if (data.defaultSkillLevel !== undefined) {
                    defaultSkillLevel = data.defaultSkillLevel;
                }
                
                // Load daily goal adjustments
                if (data.adaptiveGoal) {
                    dailyGoal = { ...dailyGoal, ...data.adaptiveGoal };
                }
                
                return data;
            }
            
            // Initialize new user data
            const newData = {
                progress: {},
                streak: 0,
                lastStudied: new Date().toDateString(),
                dailyProgress: {
                    new: 0,
                    review: 0,
                    sessions: [],
                    timeSpent: 0
                },
                accuracy: { correct: 0, total: 0 },
                totalLearned: 0,
                adaptiveGoal: dailyGoal,
                defaultSkillLevel: 0
            };
            saveProgress(newData);
            return newData;
        }

        function saveProgress(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function updateDailyGoal() {
            const data = loadProgress();
            const dailyProgress = data.dailyProgress || { new: 0, review: 0 };
            
            const totalGoal = dailyGoal.new + dailyGoal.review;
            const totalComplete = dailyProgress.new + dailyProgress.review;
            
            document.getElementById('goal-progress').textContent = `${totalComplete}/${totalGoal}`;
            document.getElementById('goal-bar').style.width = `${(totalComplete / totalGoal) * 100}%`;
            document.getElementById('words-new').textContent = `New: ${dailyProgress.new}/${dailyGoal.new}`;
            document.getElementById('words-review').textContent = `Review: ${dailyProgress.review}/${dailyGoal.review}`;
            document.getElementById('time-spent').textContent = `Time: ${Math.round(dailyProgress.timeSpent || 0)} min`;
            
            const remainingWords = totalGoal - totalComplete;
            const estimatedTime = Math.max(0, remainingWords * 1);
            document.getElementById('time-estimate').textContent = 
                remainingWords > 0 ? `~${estimatedTime} minutes remaining today` : `Daily goal complete! ðŸŽ‰`;
            
            document.getElementById('all-time').textContent = `~${remainingWords} min`;
        }

        function updateSessionProgress() {
            if (currentSession.length === 0) return;
            
            const progress = ((currentCardIndex) / currentSession.length) * 100;
            document.getElementById('session-bar').style.width = `${progress}%`;
            document.getElementById('session-correct').textContent = `Correct: ${sessionStats.correct}`;
            
            const accuracy = sessionStats.total > 0 
                ? Math.round((sessionStats.correct / sessionStats.total) * 100) 
                : 0;
            document.getElementById('session-accuracy').textContent = `Accuracy: ${accuracy}%`;
        }

        function updateStats() {
            const data = loadProgress();
            document.getElementById('streak').textContent = data.streak || 0;
            
            // Count mastered words (Advanced level with high accuracy)
            let masteredCount = 0;
            if (data.progress) {
                Object.values(data.progress).forEach(langPair => {
                    Object.values(langPair).forEach(card => {
                        const advancedStats = card.skillProgress?.[3];
                        if (advancedStats && advancedStats.total >= 3 && 
                            (advancedStats.correct / advancedStats.total) >= 0.8) {
                            masteredCount++;
                        }
                    });
                });
            }
            document.getElementById('total-learned').textContent = masteredCount;
            
            if (data.accuracy && data.accuracy.total > 0) {
                const acc = Math.round((data.accuracy.correct / data.accuracy.total) * 100);
                document.getElementById('accuracy').textContent = acc + '%';
            }
        }

        function checkPausedSession() {
            const data = loadProgress();
            if (data.pausedSession && data.pausedSession.languagePair === currentLanguagePair) {
                pausedSession = data.pausedSession;
                document.getElementById('continue-session-btn').classList.remove('hidden');
                document.getElementById('remaining-words').textContent = 
                    pausedSession.cards.length - pausedSession.currentIndex;
            } else {
                document.getElementById('continue-session-btn').classList.add('hidden');
                pausedSession = null;
            }
        }

        function startSession(size) {
            devLog(`Starting session with size: ${size}`, 'info');
            
            const data = loadProgress();
            const now = Date.now();
            currentSession = [];
            
            const vocabSet = vocabulary[currentLanguagePair] || [];
            const newCards = [];
            const reviewCards = [];
            
            vocabSet.forEach(card => {
                const cardProgress = data.progress?.[currentLanguagePair]?.[card.id];
                if (!cardProgress) {
                    newCards.push({...card, type: 'new'});
                } else if (cardProgress.nextReview <= now) {
                    reviewCards.push({...card, type: 'review'});
                }
            });
            
            devLog(`Available: ${newCards.length} new, ${reviewCards.length} review cards`, 'info');
            
            let targetNew = 0;
            let targetReview = 0;
            
            const completedNew = data.dailyProgress?.new || 0;
            const completedReview = data.dailyProgress?.review || 0;
            
            if (size === 0) {
                targetNew = Math.max(0, dailyGoal.new - completedNew);
                targetReview = Math.max(0, dailyGoal.review - completedReview);
            } else {
                let remainingSize = size;
                
                const reviewsNeeded = Math.max(0, dailyGoal.review - completedReview);
                targetReview = Math.min(remainingSize, reviewCards.length, reviewsNeeded);
                remainingSize -= targetReview;
                
                if (remainingSize > 0) {
                    const newNeeded = Math.max(0, dailyGoal.new - completedNew);
                    targetNew = Math.min(remainingSize, newCards.length, newNeeded);
                }
                
                if (targetNew + targetReview < size && completedNew >= dailyGoal.new && completedReview >= dailyGoal.review) {
                    const extraReviews = Math.min(size - targetNew - targetReview, reviewCards.length - targetReview);
                    targetReview += extraReviews;
                }
                
                if (targetNew + targetReview < size) {
                    const extraNew = Math.min(size - targetNew - targetReview, newCards.length - targetNew);
                    targetNew += extraNew;
                }
            }
            
            currentSession = [
                ...reviewCards.slice(0, targetReview),
                ...newCards.slice(0, targetNew)
            ];
            
            if (currentSession.length === 0) {
                const feedback = `
                    <div class="no-cards">
                        <h2>No Cards Available</h2>
                        <p style="margin: 20px 0;">
                            ${reviewCards.length === 0 && newCards.length === 0 ? 
                                'All cards are scheduled for future review. Great job! Come back tomorrow.' :
                                'You\'ve completed your daily goals! Come back tomorrow for more practice.'}
                        </p>
                        <p style="color: #666; font-size: 14px;">
                            Next review: Tomorrow<br>
                            Cards mastered: ${document.getElementById('total-learned').textContent}
                        </p>
                        <button class="btn-primary" onclick="backToStart()">Back to Home</button>
                    </div>
                `;
                document.getElementById('complete-screen').innerHTML = feedback;
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('complete-screen').classList.remove('hidden');
                return;
            }
            
            // Shuffle session
            currentSession.sort(() => Math.random() - 0.5);
            devLog(`Starting session with ${currentSession.length} cards`, 'success');
            
            // Initialize session
            sessionStats = {
                correct: 0,
                total: 0,
                startTime: Date.now(),
                wordsCompleted: []
            };
            currentCardIndex = 0;
            
            // Clear paused session
            pausedSession = null;
            const saveData = loadProgress();
            delete saveData.pausedSession;
            saveProgress(saveData);
            
            // Switch to study mode UI
            document.getElementById('main-container').classList.add('study-mode');
            document.querySelector('.header').classList.add('hidden');
            document.querySelector('.daily-goal').classList.add('hidden');
            document.querySelector('.stats').classList.add('hidden');
            document.querySelector('.language-selector').classList.add('hidden');
            document.querySelector('.skill-selector').classList.add('hidden');
            
            // Show study screen
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.remove('hidden');
            
            showCard();
        }

        function continueSession() {
            if (!pausedSession) return;
            
            currentSession = pausedSession.cards;
            currentCardIndex = pausedSession.currentIndex;
            sessionStats = pausedSession.stats;
            
            // Clear paused session from storage
            const data = loadProgress();
            delete data.pausedSession;
            saveProgress(data);
            pausedSession = null;
            
            // Switch to study mode UI
            document.getElementById('main-container').classList.add('study-mode');
            document.querySelector('.header').classList.add('hidden');
            document.querySelector('.daily-goal').classList.add('hidden');
            document.querySelector('.stats').classList.add('hidden');
            document.querySelector('.language-selector').classList.add('hidden');
            document.querySelector('.skill-selector').classList.add('hidden');
            
            // Show study screen
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.remove('hidden');
            
            showCard();
        }

        function pauseSession() {
            const data = loadProgress();
            
            // Save session state
            data.pausedSession = {
                cards: currentSession,
                currentIndex: currentCardIndex,
                stats: sessionStats,
                languagePair: currentLanguagePair
            };
            
            // Update time spent
            if (sessionStats.startTime) {
                const timeSpent = (Date.now() - sessionStats.startTime) / 60000;
                data.dailyProgress.timeSpent = (data.dailyProgress.timeSpent || 0) + timeSpent;
            }
            
            saveProgress(data);
            
            // Return to home
            backToStart();
        }

        function showCard() {
            if (currentCardIndex >= currentSession.length) {
                completeSession();
                return;
            }
            
            const card = currentSession[currentCardIndex];
            
            // Determine skill level for this card
            currentCardSkillLevel = determineCardSkillLevel(card.id);
            devLog(`Showing card ${card.id} at ${SKILL_NAMES[currentCardSkillLevel]} level`, 'info');
            
            // Update skill display
            updateCardSkillDisplay(card.id);
            
            // Reset UI
            document.getElementById('word').textContent = card.word;
            document.getElementById('category').textContent = card.category;
            document.getElementById('feedback').classList.add('hidden');
            isAnswerShown = false;
            selectedChoiceIndex = -1;
            
            // Hide romanization initially
            const romanizationEl = document.getElementById('romanization');
            if (card.romanization) {
                romanizationEl.textContent = card.romanization;
                romanizationEl.classList.add('hidden');
            } else {
                romanizationEl.classList.add('hidden');
            }
            
            // Show appropriate input method based on skill level
            const choiceGrid = document.getElementById('choice-grid');
            const inputGroup = document.getElementById('input-group');
            
            if (currentCardSkillLevel === SKILL_LEVELS.BEGINNER) {
                // Multiple choice
                choiceGrid.classList.remove('hidden');
                inputGroup.classList.add('hidden');
                
                const vocabSet = vocabulary[currentLanguagePair] || [];
                const options = generateMultipleChoice(card, vocabSet);
                renderMultipleChoice(options);
            } else {
                // Text input for intermediate and advanced
                choiceGrid.classList.add('hidden');
                inputGroup.classList.remove('hidden');
                document.getElementById('answer').value = '';
                document.getElementById('answer').focus();
                
                // Update placeholder based on level
                const placeholder = currentCardSkillLevel === SKILL_LEVELS.INTERMEDIATE ?
                    'Type the translation (diacritics optional)...' :
                    'Type the exact translation...';
                document.getElementById('answer').placeholder = placeholder;
            }
            
            // Update progress display
            document.getElementById('current-word-num').textContent = currentCardIndex + 1;
            document.getElementById('total-words').textContent = currentSession.length;
            
            // Reset button
            const button = document.getElementById('action-button');
            button.textContent = 'Check Answer';
            button.classList.remove('next');
            
            updateSessionProgress();
        }

        function checkAnswer() {
            if (isAnswerShown) {
                nextCard();
                return;
            }
            
            const card = currentSession[currentCardIndex];
            let isCorrect = false;
            let feedbackMessage = '';
            let feedbackClass = '';
            
            if (currentCardSkillLevel === SKILL_LEVELS.BEGINNER) {
                // Multiple choice
                if (selectedChoiceIndex === -1) {
                    devLog('No choice selected', 'error');
                    return;
                }
                
                const choices = document.querySelectorAll('.choice-btn');
                const selectedBtn = choices[selectedChoiceIndex];
                isCorrect = selectedBtn.dataset.correct === 'true';
                
                // Visual feedback
                choices.forEach(btn => {
                    if (btn.dataset.correct === 'true') {
                        btn.classList.add('correct');
                    } else if (btn === selectedBtn && !isCorrect) {
                        btn.classList.add('incorrect');
                    } else {
                        btn.classList.add('dimmed');
                    }
                    btn.disabled = true;
                });
                
                feedbackMessage = isCorrect ? 'âœ“ Correct!' : `âœ— Incorrect. The answer is: <strong>${card.translation}</strong>`;
                feedbackClass = isCorrect ? 'correct' : 'incorrect';
                
            } else if (currentCardSkillLevel === SKILL_LEVELS.INTERMEDIATE) {
                // Flexible typing
                const userAnswer = document.getElementById('answer').value.trim();
                const correctAnswer = card.translation;
                
                isCorrect = checkIntermediateAnswer(userAnswer, correctAnswer);
                
                if (isCorrect && normalizeAnswer(userAnswer) !== normalizeAnswer(correctAnswer)) {
                    feedbackMessage = `âœ“ Close enough! The exact spelling is: <strong>${correctAnswer}</strong>`;
                    feedbackClass = 'intermediate';
                } else if (isCorrect) {
                    feedbackMessage = 'âœ“ Perfect!';
                    feedbackClass = 'correct';
                } else {
                    feedbackMessage = `âœ— Incorrect. The answer is: <strong>${correctAnswer}</strong>`;
                    feedbackClass = 'incorrect';
                }
                
            } else {
                // Advanced - exact match
                const userAnswer = document.getElementById('answer').value.trim().toLowerCase();
                const correctAnswer = card.translation.toLowerCase();
                
                isCorrect = userAnswer === correctAnswer || 
                          userAnswer === correctAnswer.replace(/\s+/g, '');
                
                feedbackMessage = isCorrect ? 'âœ“ Perfect!' : `âœ— Incorrect. The answer is: <strong>${card.translation}</strong>`;
                feedbackClass = isCorrect ? 'correct' : 'incorrect';
            }
            
            // Show romanization when answer is checked
            const romanizationEl = document.getElementById('romanization');
            if (card.romanization) {
                romanizationEl.classList.remove('hidden');
            }
            
            // Show feedback
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden');
            feedback.className = `feedback ${feedbackClass}`;
            feedback.innerHTML = feedbackMessage;
            
            // Update progress
            updateCardProgressWithSkillLevel(card.id, isCorrect, currentCardSkillLevel, card.type);
            
            if (isCorrect) {
                sessionStats.correct++;
            }
            sessionStats.total++;
            sessionStats.wordsCompleted.push(card.id);
            
            isAnswerShown = true;
            
            // Change button to "Next Card"
            const button = document.getElementById('action-button');
            button.textContent = currentCardIndex === currentSession.length - 1 ? 'Finish' : 'Next Card';
            button.classList.add('next');
            
            updateSessionProgress();
        }

        function nextCard() {
            currentCardIndex++;
            showCard();
        }

        function updateCardProgressWithSkillLevel(cardId, isCorrect, skillLevel, cardType) {
            const data = loadProgress();
            
            devLog(`Updating card ${cardId}: ${isCorrect ? 'CORRECT' : 'INCORRECT'} at ${SKILL_NAMES[skillLevel]} level (${cardType})`, isCorrect ? 'success' : 'error');
            
            if (!data.progress) data.progress = {};
            if (!data.progress[currentLanguagePair]) data.progress[currentLanguagePair] = {};
            
            let cardProgress = data.progress[currentLanguagePair][cardId];
            const isNewCard = !cardProgress;
            
            if (!cardProgress) {
                // Initialize new card
                cardProgress = {
                    level: 0,
                    lastSeen: Date.now(),
                    timesCorrect: 0,
                    timesSeen: 0,
                    skillLevel: skillLevel,
                    skillProgress: {
                        1: { correct: 0, total: 0, streak: 0 },
                        2: { correct: 0, total: 0, streak: 0 },
                        3: { correct: 0, total: 0, streak: 0 }
                    },
                    recommendedSkillLevel: 1
                };
            }
            
            // Update skill-specific statistics
            if (!cardProgress.skillProgress) {
                cardProgress.skillProgress = {
                    1: { correct: 0, total: 0, streak: 0 },
                    2: { correct: 0, total: 0, streak: 0 },
                    3: { correct: 0, total: 0, streak: 0 }
                };
            }
            
            const skillStats = cardProgress.skillProgress[skillLevel];
            skillStats.total++;
            
            if (isCorrect) {
                skillStats.correct++;
                skillStats.streak++;
                
                // Apply skill multiplier to level progression
                const multiplier = SKILL_MULTIPLIERS[skillLevel];
                cardProgress.level = Math.min(5, cardProgress.level + multiplier);
                cardProgress.timesCorrect++;
                
                devLog(`Card level increased by ${multiplier} to ${cardProgress.level}`, 'info');
            } else {
                skillStats.streak = 0;
                
                // Bigger penalty for failing at easier levels
                const penalty = skillLevel === SKILL_LEVELS.BEGINNER ? 0.5 : 1.0;
                cardProgress.level = Math.max(0, cardProgress.level - penalty);
                
                devLog(`Card level decreased by ${penalty} to ${cardProgress.level}`, 'info');
            }
            
            cardProgress.timesSeen++;
            cardProgress.lastSeen = Date.now();
            cardProgress.skillLevel = skillLevel;
            
            // Calculate next review time based on fractional level
            const effectiveLevel = Math.floor(cardProgress.level);
            const fraction = cardProgress.level - effectiveLevel;
            
            let daysUntilNext;
            if (effectiveLevel >= BASE_INTERVALS.length - 1) {
                daysUntilNext = BASE_INTERVALS[BASE_INTERVALS.length - 1];
            } else {
                const lowerDays = BASE_INTERVALS[effectiveLevel];
                const upperDays = BASE_INTERVALS[effectiveLevel + 1];
                daysUntilNext = lowerDays + (upperDays - lowerDays) * fraction;
            }
            
            cardProgress.nextReview = Date.now() + (daysUntilNext * 86400000);
            
            devLog(`Next review in ${Math.round(daysUntilNext)} days`, 'info');
            
            // Check for skill level promotion
            if (skillStats.streak >= PROMOTION_THRESHOLD.streak && 
                skillStats.total >= 3 &&
                (skillStats.correct / skillStats.total) >= PROMOTION_THRESHOLD.accuracy &&
                skillLevel < 3) {
                cardProgress.recommendedSkillLevel = skillLevel + 1;
                devLog(`Card ${cardId} ready for promotion to ${SKILL_NAMES[skillLevel + 1]}!`, 'success');
            }
            
            data.progress[currentLanguagePair][cardId] = cardProgress;
            
            // Update daily progress
            if (!data.dailyProgress) {
                data.dailyProgress = { new: 0, review: 0, sessions: [], timeSpent: 0 };
            }
            
            // Create a unique session ID for tracking cards in this session
            const sessionId = sessionStats.startTime || Date.now();
            if (!data.dailyProgress.cardsSeen) {
                data.dailyProgress.cardsSeen = {};
            }
            
            // Track if this card was already counted in today's progress
            const cardSeenToday = data.dailyProgress.cardsSeen[cardId];
            
            if (!cardSeenToday) {
                // First time seeing this card today
                data.dailyProgress.cardsSeen[cardId] = true;
                
                if (isNewCard || cardType === 'new') {
                    // This is a new card
                    data.dailyProgress.new = Math.min(dailyGoal.new + 10, (data.dailyProgress.new || 0) + 1);
                    devLog(`Daily new words: ${data.dailyProgress.new}/${dailyGoal.new}`, 'info');
                    
                    // Count as learned if mastered at advanced level
                    if (isCorrect && skillLevel === SKILL_LEVELS.ADVANCED) {
                        data.totalLearned = (data.totalLearned || 0) + 1;
                    }
                } else {
                    // This is a review card
                    data.dailyProgress.review = Math.min(dailyGoal.review + 10, (data.dailyProgress.review || 0) + 1);
                    devLog(`Daily review words: ${data.dailyProgress.review}/${dailyGoal.review}`, 'info');
                }
            }
            
            // Update overall accuracy
            if (!data.accuracy) data.accuracy = { correct: 0, total: 0 };
            data.accuracy.total++;
            if (isCorrect) data.accuracy.correct++;
            
            saveProgress(data);
            updateDailyGoal();
            updateStats();
        }

        function completeSession() {
            const data = loadProgress();
            
            // Calculate session time
            const sessionTime = sessionStats.startTime ? 
                Math.round((Date.now() - sessionStats.startTime) / 60000) : 0;
            
            // Update time spent
            data.dailyProgress.timeSpent = (data.dailyProgress.timeSpent || 0) + sessionTime;
            
            // Add to session history
            if (!data.dailyProgress.sessions) data.dailyProgress.sessions = [];
            data.dailyProgress.sessions.push({
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                words: sessionStats.total,
                accuracy: sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0
            });
            
            // Adaptive goal adjustment
            adjustDailyGoal(data);
            
            saveProgress(data);
            showCompleteScreen();
        }

        function adjustDailyGoal(data) {
            const dailyProgress = data.dailyProgress;
            const sessions = dailyProgress.sessions || [];
            
            // Only adjust after completing at least 2 sessions
            if (sessions.length < 2) return;
            
            // Calculate average accuracy for today
            const todayAccuracy = sessions.reduce((acc, s) => acc + s.accuracy, 0) / sessions.length;
            
            // Adjust goals for tomorrow
            if (todayAccuracy > 85 && dailyProgress.new >= dailyGoal.new && dailyProgress.review >= dailyGoal.review) {
                // Increase slightly if doing well and completing goals
                dailyGoal.new = Math.min(10, dailyGoal.new + 1);
                dailyGoal.review = Math.min(15, dailyGoal.review + 1);
                devLog('Daily goals increased due to excellent performance!', 'success');
            } else if (todayAccuracy < 60) {
                // Decrease if struggling
                dailyGoal.new = Math.max(2, dailyGoal.new - 1);
                dailyGoal.review = Math.max(3, dailyGoal.review - 1);
                devLog('Daily goals decreased to reduce pressure', 'info');
            }
            
            // Save adjusted goals
            data.adaptiveGoal = dailyGoal;
        }

        function showCompleteScreen() {
            const data = loadProgress();
            const totalGoal = dailyGoal.new + dailyGoal.review;
            const totalComplete = (data.dailyProgress?.new || 0) + (data.dailyProgress?.review || 0);
            
            // Rebuild complete screen HTML to ensure all elements exist
            const completeScreen = document.getElementById('complete-screen');
            completeScreen.innerHTML = `
                <div id="achievement" class="achievement ${totalComplete >= totalGoal ? '' : 'hidden'}">
                    <div class="achievement-title">ðŸŽ‰ Goal Achieved!</div>
                    <div class="achievement-desc">You've completed your daily goal!</div>
                </div>
                
                <div class="no-cards">
                    <h2>Session Complete!</h2>
                    <p style="margin: 20px 0;">
                        Words practiced: <strong>${sessionStats.total}</strong><br>
                        Accuracy: <strong>${sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0}%</strong><br>
                        Time: <strong>${sessionStats.startTime ? Math.round((Date.now() - sessionStats.startTime) / 60000) : 0}</strong> minutes
                    </p>
                    <button class="btn-primary" onclick="backToStart()">Continue Learning</button>
                    <button class="btn-secondary" onclick="finishForToday()" style="margin-top: 10px;">Finish for Now</button>
                </div>
            `;
            
            // Show complete screen
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('complete-screen').classList.remove('hidden');
            
            // Remove study mode
            document.getElementById('main-container').classList.remove('study-mode');
            
            updateStats();
        }

        function updateSessionHistory() {
            const data = loadProgress();
            const sessions = data.dailyProgress?.sessions || [];
            const historyDiv = document.getElementById('session-history');
            
            if (sessions.length === 0) {
                historyDiv.innerHTML = '<div style="color: #999; font-size: 13px;">No sessions yet today</div>';
                return;
            }
            
            historyDiv.innerHTML = sessions.map(s => `
                <div class="history-item">
                    <span>${s.time}</span>
                    <span>${s.words} words â€¢ ${s.accuracy}%</span>
                </div>
            `).join('');
        }

        function backToStart() {
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('complete-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            
            // Restore normal UI
            document.getElementById('main-container').classList.remove('study-mode');
            document.querySelector('.header').classList.remove('hidden');
            document.querySelector('.daily-goal').classList.remove('hidden');
            document.querySelector('.stats').classList.remove('hidden');
            document.querySelector('.language-selector').classList.remove('hidden');
            document.querySelector('.skill-selector').classList.remove('hidden');
            
            updateDailyGoal();
            updateStats();
            checkPausedSession();
            updateSessionHistory();
        }

        function finishForToday() {
            backToStart();
        }

        // Initialize when page loads
        window.onload = initApp;
    </script>